<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus | Control Center</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="{{ url_for('static', filename='js/theme-preference.js') }}"></script>
    <style>
        /* ═════════════════════════════════════════════════════════
           THE DREAM TEAM - CONTROL CENTER
           Design Philosophy: Apple-level perfection + WOW factor
           PIXEL's Vision: Make every pixel magical
           ═════════════════════════════════════════════════════════ */

        :root {
            /* Default: Pixel Light Theme */
            --bg-primary: #f3f6fc;
            --bg-secondary: #eaf0fb;
            --bg-tertiary: #ffffff;
            --bg-glass: rgba(255, 255, 255, 0.82);
            --bg-glass-hover: rgba(255, 255, 255, 0.96);

            --text-primary: #0f1a33;
            --text-secondary: rgba(15, 26, 51, 0.78);
            --text-tertiary: rgba(15, 26, 51, 0.55);
            --text-muted: rgba(15, 26, 51, 0.32);

            --orion-primary: #007AFF;
            --orion-secondary: #5856D6;
            --orion-glow: rgba(0, 122, 255, 0.3);
            --guardian-primary: #30D158;
            --guardian-glow: rgba(48, 209, 88, 0.3);
            --nova-primary: #FF9500;
            --pixel-primary: #FF2D55;
            --cipher-primary: #AF52DE;
            --echo-primary: #00C7BE;
            --flux-primary: #FF375F;
            --warning: #FF9F0A;
            --danger: #FF453A;
            --success: #30D158;

            --border-subtle: rgba(15, 26, 51, 0.08);
            --border-light: rgba(15, 26, 51, 0.15);

            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(33, 56, 105, 0.12);
            --shadow-md: 0 8px 24px rgba(33, 56, 105, 0.14);
            --shadow-lg: 0 20px 45px rgba(33, 56, 105, 0.18);
            --shadow-glow: 0 0 40px var(--orion-glow);
            --shadow-glow-green: 0 0 40px var(--guardian-glow);

            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 400ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: 500ms cubic-bezier(0.34, 1.56, 0.64, 1);

            /* Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-xl: 28px;
        }

        body.theme-dark {
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-tertiary: #141414;
            --bg-glass: rgba(255, 255, 255, 0.03);
            --bg-glass-hover: rgba(255, 255, 255, 0.06);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-tertiary: rgba(255, 255, 255, 0.4);
            --text-muted: rgba(255, 255, 255, 0.2);
            --border-subtle: rgba(255, 255, 255, 0.06);
            --border-light: rgba(255, 255, 255, 0.1);
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background:
                radial-gradient(1200px 700px at 0% 0%, rgba(0,122,255,0.1), transparent 60%),
                radial-gradient(900px 600px at 100% 100%, rgba(48,209,88,0.08), transparent 60%),
                var(--bg-primary);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body.minimal-mode .model-card,
        body.minimal-mode .advisor-card,
        body.minimal-mode .ops-feed-card,
        body.minimal-mode .decisions-card {
            display: none;
        }

        body.focus-mode .model-card,
        body.focus-mode .advisor-card,
        body.focus-mode .ops-feed-card,
        body.focus-mode .fleet-card,
        body.focus-mode .agent-panel {
            display: none;
        }

        body.focus-mode .main {
            grid-template-columns: minmax(0, 1fr);
            max-width: 980px;
            margin: 0 auto;
        }

        body.focus-mode .command-console {
            max-height: 320px;
        }

        body.performance-mode .bg-animation,
        body.performance-mode .bg-orb,
        body.performance-mode .bg-grid {
            display: none !important;
            animation: none !important;
        }

        body.performance-mode .fade-in,
        body.performance-mode .empty-state-icon,
        body.performance-mode .live-indicator::before,
        body.performance-mode .voice-btn.recording .voice-icon {
            animation: none !important;
        }

        body.performance-mode *,
        body.performance-mode *::before,
        body.performance-mode *::after {
            transition: none !important;
            animation: none !important;
        }

        /* ═════════════════════════════════════════════════════════
           MAIN LAYOUT
           ═════════════════════════════════════════════════════════ */

        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }

        /* Header - Floating Island Style */
        .header {
            position: fixed;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            background: var(--bg-glass);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid var(--border-subtle);
            border-radius: 100px;
            box-shadow: var(--shadow-lg);
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 12px 4px 4px;
        }

        .header-logo-icon {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--orion-primary), #5856D6);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }

        .header-logo-text {
            font-weight: 600;
            font-size: 13px;
            letter-spacing: -0.3px;
        }

        .header-divider {
            width: 1px;
            height: 20px;
            background: var(--border-light);
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 0 8px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s ease-in-out infinite;
        }

        .status-dot.orion { background: var(--orion-primary); }
        .status-dot.guardian { background: var(--guardian-primary); }
        .status-dot.monitor { background: var(--warning); }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.9); }
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .header-options {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-right: 4px;
        }

        .header-options select {
            height: 30px;
            border: 1px solid var(--border-light);
            border-radius: 999px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 0 10px;
            font-size: 11px;
            outline: none;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .header-options select:hover {
            color: var(--text-primary);
            border-color: var(--orion-primary);
        }

        .header-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .header-btn:hover {
            background: var(--bg-glass-hover);
            color: var(--text-primary);
        }

        .header-btn.danger:hover {
            background: rgba(255, 69, 58, 0.15);
            color: var(--danger);
        }

        .header-btn.active {
            background: var(--bg-glass-hover);
            color: var(--text-primary);
        }

        /* ═════════════════════════════════════════════════════════
           MAIN CONTENT
           ═════════════════════════════════════════════════════════ */

        .main {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 400px 1fr;
            gap: 16px;
            padding: 72px 20px 20px;
            overflow: hidden;
            height: 100vh;
        }

        /* Agent Panels */
        .agent-panel {
            display: flex;
            flex-direction: column;
            background: var(--bg-glass);
            backdrop-filter: blur(40px);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            overflow: hidden;
        }

        .agent-panel.orion {
            border-top: 2px solid var(--orion-primary);
        }

        .agent-panel.guardian {
            border-top: 2px solid var(--guardian-primary);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .panel-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .orion .panel-icon {
            background: linear-gradient(135deg, var(--orion-primary), #5856D6);
        }

        .guardian .panel-icon {
            background: linear-gradient(135deg, var(--guardian-primary), #34C759);
        }

        .panel-name {
            font-size: 16px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .panel-role {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 2px;
        }

        .panel-badge {
            padding: 4px 10px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 500;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .panel-badge.active {
            background: rgba(48, 209, 88, 0.15);
            color: var(--success);
        }

        /* Thinking Section */
        .thinking-section {
            padding: 16px 20px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-subtle);
        }

        .thinking-label {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .thinking-content {
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-secondary);
            white-space: pre-wrap;
            font-family: 'JetBrains Mono', monospace;
            max-height: 120px;
            overflow-y: auto;
        }

        /* Activity Logs */
        .logs-section {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .logs-header {
            padding: 16px 20px;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .logs-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .log-entry {
            padding: 10px 14px;
            margin-bottom: 6px;
            border-radius: var(--radius-md);
            font-size: 13px;
            line-height: 1.4;
            background: var(--bg-tertiary);
            border-left: 2px solid var(--text-muted);
            transition: var(--transition-fast);
        }

        .log-entry:hover {
            background: var(--bg-glass-hover);
        }

        .log-entry.info { border-left-color: var(--orion-primary); }
        .log-entry.success { border-left-color: var(--success); }
        .log-entry.warning { border-left-color: var(--warning); }
        .log-entry.error { border-left-color: var(--danger); }

        .log-time {
            font-size: 10px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 4px;
        }

        .log-message {
            color: var(--text-secondary);
        }

        /* Center Panel */
        .center-panel {
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: 0;
        }

        /* Project Card */
        .project-card {
            background: var(--bg-glass);
            backdrop-filter: blur(40px);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: 24px;
        }

        .project-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .project-info h2 {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: -0.5px;
            margin-bottom: 4px;
        }

        .project-status {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        .project-score {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
        }

        .score-value {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--orion-primary), #5856D6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .score-label {
            font-size: 11px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .project-score .sparkline {
            width: 120px;
            height: 30px;
            opacity: 0.8;
        }

        .project-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            padding-top: 20px;
            border-top: 1px solid var(--border-subtle);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        .flow-card {
            background: var(--bg-glass);
            backdrop-filter: blur(40px);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: 16px 18px;
        }

        .flow-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 10px;
        }

        .flow-title {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: -0.2px;
        }

        .flow-metrics {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .flow-chip {
            border: 1px solid var(--border-light);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 999px;
            font-size: 11px;
            padding: 4px 8px;
            white-space: nowrap;
        }

        .flow-list {
            display: grid;
            gap: 8px;
        }

        .instance-strip {
            display: grid;
            gap: 8px;
            margin-bottom: 10px;
        }

        .instance-item {
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            padding: 8px 10px;
            display: grid;
            gap: 6px;
        }

        .instance-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .instance-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .instance-meta {
            font-size: 10px;
            color: var(--text-tertiary);
        }

        .instance-actions {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .instance-btn {
            border: 1px solid var(--border-light);
            border-radius: 999px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 10px;
            padding: 4px 8px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .instance-btn:hover {
            border-color: var(--orion-primary);
            color: var(--text-primary);
            background: var(--bg-glass-hover);
        }

        .flow-item {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 10px;
            align-items: center;
            padding: 9px 10px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-subtle);
            background: var(--bg-tertiary);
        }

        .flow-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .flow-item.active .flow-dot {
            background: var(--success);
            box-shadow: 0 0 0 3px rgba(48, 209, 88, 0.18);
        }

        .flow-main {
            min-width: 0;
        }

        .flow-name {
            font-size: 12px;
            color: var(--text-primary);
            font-weight: 600;
            line-height: 1.3;
        }

        .flow-desc {
            font-size: 11px;
            color: var(--text-tertiary);
            line-height: 1.35;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .flow-status {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            color: var(--text-tertiary);
        }

        .flow-item.active .flow-status {
            color: var(--success);
            font-weight: 600;
        }

        .insight-card {
            background: linear-gradient(120deg, rgba(0,122,255,0.12), rgba(88,86,214,0.08));
            border: 1px solid rgba(0,122,255,0.2);
            border-radius: var(--radius-xl);
            padding: 16px 18px;
        }

        .insight-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .insight-title {
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 0.2px;
        }

        .insight-mode {
            font-size: 10px;
            color: var(--text-tertiary);
            border: 1px solid var(--border-light);
            border-radius: 999px;
            padding: 4px 8px;
            background: var(--bg-tertiary);
        }

        .insight-grid {
            display: grid;
            gap: 8px;
        }

        .insight-block {
            background: rgba(255, 255, 255, 0.65);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 9px 10px;
        }

        body.theme-dark .insight-block {
            background: rgba(255, 255, 255, 0.03);
        }

        .insight-label {
            font-size: 10px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.25px;
            margin-bottom: 4px;
        }

        .insight-value {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Command Input */
        .command-card {
            background: var(--bg-glass);
            backdrop-filter: blur(40px);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: 20px;
        }

        /* Task Panel - IMPROVED */
        .task-panel {
            background: var(--bg-glass);
            backdrop-filter: blur(40px);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: 16px;
            margin-top: 16px;
        }
        .task-panel-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border-subtle);
        }
        .task-panel-header span { font-size: 14px; font-weight: 600; }
        .task-add-btn {
            padding: 8px 16px; background: linear-gradient(135deg, #00d4ff, #7b2ff7); border: none;
            border-radius: 8px; color: white; font-size: 12px; font-weight: 600; cursor: pointer;
            transition: all 0.2s; display: flex; align-items: center; gap: 6px;
        }
        .task-add-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4); }
        .task-panel-body { max-height: 250px; overflow-y: auto; }
        .task-item {
            padding: 12px 14px; background: var(--bg-tertiary); border-radius: 10px;
            margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: all 0.2s; border: 1px solid transparent;
        }
        .task-item:hover { border-color: var(--orion-primary); transform: translateX(4px); }
        .task-item-left { display: flex; align-items: center; gap: 12px; }
        .task-item-check {
            width: 20px; height: 20px; border: 2px solid #444; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }
        .task-item.completed .task-item-check { background: #3fb950; border-color: #3fb950; }
        .task-item.completed .task-item-check::after { content: '✓'; color: white; font-size: 12px; }
        .task-item-title { font-size: 14px; font-weight: 500; }
        .task-item.completed .task-item-title { text-decoration: line-through; opacity: 0.5; }
        .task-item-priority {
            font-size: 10px; padding: 4px 10px; border-radius: 20px; font-weight: 600; text-transform: uppercase;
        }
        .task-priority-urgent { background: rgba(248,81,73,0.2); color: #f85149; }
        .task-priority-high { background: rgba(210,153,34,0.2); color: #d29922; }
        .task-priority-medium { background: rgba(88,166,255,0.2); color: #58a6ff; }
        .task-priority-low { background: rgba(139,148,158,0.2); color: #8b949e; }
        .task-loading { color: #666; font-size: 13px; text-align: center; padding: 20px; }
        .task-empty { text-align: center; padding: 30px; color: #666; }
        .task-empty-icon { font-size: 40px; margin-bottom: 10px; }

        .control-dock {
            background: var(--bg-glass);
            backdrop-filter: blur(40px);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: 18px;
            display: grid;
            gap: 14px;
        }

        .agreement-card {
            background: var(--bg-glass);
            backdrop-filter: blur(40px);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: 18px;
            display: grid;
            gap: 12px;
        }

        .provider-card {
            background: var(--bg-glass);
            backdrop-filter: blur(40px);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: 18px;
            display: grid;
            gap: 14px;
        }

        .provider-head {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .provider-title {
            font-size: 14px;
            font-weight: 600;
        }

        .provider-sub {
            margin-top: 4px;
            font-size: 11px;
            color: var(--text-tertiary);
            max-width: 540px;
        }

        .provider-meta {
            font-size: 10px;
            color: var(--text-tertiary);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 999px;
            padding: 4px 10px;
            white-space: nowrap;
        }

        .provider-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            flex-wrap: wrap;
        }

        .provider-actions-left {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .provider-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }

        .provider-box {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 12px;
            display: grid;
            gap: 8px;
        }

        .provider-box.api {
            border-top: 2px solid rgba(48, 209, 88, 0.45);
        }

        .provider-box.subscription {
            border-top: 2px solid rgba(0, 122, 255, 0.45);
        }

        .provider-box-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .provider-box-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .provider-box-kind {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.35px;
            color: var(--text-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 999px;
            padding: 3px 7px;
        }

        .provider-field {
            display: grid;
            gap: 4px;
        }

        .provider-field label {
            font-size: 10px;
            color: var(--text-tertiary);
            letter-spacing: 0.2px;
            text-transform: uppercase;
        }

        .provider-field input,
        .provider-field select {
            width: 100%;
            height: 32px;
            border: 1px solid var(--border-light);
            border-radius: 10px;
            padding: 0 10px;
            font-size: 12px;
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .provider-field input:focus,
        .provider-field select:focus {
            outline: none;
            border-color: var(--orion-primary);
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.18);
        }

        .provider-toggle {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .provider-toggle input[type="checkbox"] {
            accent-color: var(--orion-primary);
        }

        .provider-key-hint {
            font-size: 10px;
            color: var(--text-tertiary);
        }

        .provider-routing {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 8px;
            border-top: 1px solid var(--border-subtle);
            padding-top: 12px;
        }

        .provider-bindings {
            border-top: 1px solid var(--border-subtle);
            padding-top: 12px;
            display: grid;
            gap: 8px;
        }

        .provider-bindings-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .provider-binding-row {
            display: grid;
            grid-template-columns: 120px 1fr 1fr auto;
            gap: 8px;
            align-items: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 8px;
        }

        .provider-binding-agent {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 0.2px;
            text-transform: uppercase;
        }

        .provider-loading {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .agreement-head {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
        }

        .agreement-title {
            font-size: 14px;
            font-weight: 600;
        }

        .agreement-sub {
            margin-top: 4px;
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .agreement-meta {
            font-size: 10px;
            color: var(--text-tertiary);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 999px;
            padding: 4px 8px;
            white-space: nowrap;
        }

        .agreement-textarea {
            width: 100%;
            min-height: 120px;
            resize: vertical;
            padding: 10px 12px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 12px;
            line-height: 1.5;
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, monospace;
        }

        .agreement-textarea:focus {
            outline: none;
            border-color: var(--orion-primary);
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
        }

        .agreement-actions {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
        }

        .agreement-btn {
            padding: 6px 12px;
            border-radius: 999px;
            border: none;
            background: var(--orion-primary);
            color: white;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: transform var(--transition-fast), box-shadow var(--transition-fast);
        }

        .agreement-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .agreement-btn.ghost {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-light);
        }

        .control-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .control-title {
            font-size: 14px;
            font-weight: 600;
        }

        .control-sub {
            margin-top: 4px;
            font-size: 11px;
            color: var(--text-tertiary);
            max-width: 420px;
        }

        .control-badges {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .control-badge {
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-tertiary);
            font-size: 10px;
            color: var(--text-secondary);
            letter-spacing: 0.2px;
        }

        .control-grid {
            display: grid;
            gap: 10px;
        }

        .control-group {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 12px;
            display: grid;
            gap: 8px;
        }

        .control-group-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .control-group-title {
            font-size: 12px;
            font-weight: 600;
        }

        .control-group-desc {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .control-group-chip {
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-secondary);
            font-size: 10px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .control-btn {
            padding: 8px 12px;
            border: 1px solid var(--border-light);
            border-radius: 999px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .control-btn:hover {
            background: var(--bg-glass-hover);
            color: var(--text-primary);
        }

        .control-btn.primary {
            background: var(--orion-primary);
            color: #fff;
            border-color: transparent;
        }

        .control-btn.success {
            background: rgba(48, 209, 88, 0.16);
            border-color: rgba(48, 209, 88, 0.35);
            color: var(--guardian-primary);
        }

        .control-btn.warning {
            background: rgba(255, 159, 10, 0.16);
            border-color: rgba(255, 159, 10, 0.35);
            color: var(--warning);
        }

        .control-btn.danger {
            background: rgba(255, 69, 58, 0.16);
            border-color: rgba(255, 69, 58, 0.35);
            color: var(--danger);
        }

        .control-footer {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .command-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .command-head-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .command-title {
            font-size: 14px;
            font-weight: 500;
        }

        .voice-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border: 1px solid var(--border-light);
            border-radius: 100px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .voice-btn:hover {
            background: var(--bg-glass-hover);
            color: var(--text-primary);
        }

        .voice-btn.recording {
            background: rgba(255, 69, 58, 0.15);
            border-color: var(--danger);
            color: var(--danger);
        }

        .voice-btn.recording .voice-icon {
            animation: pulse 1s ease-in-out infinite;
        }

        .command-live-toggle {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border: 1px solid var(--border-light);
            border-radius: 100px;
            background: transparent;
            color: var(--text-tertiary);
            font-size: 11px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .command-live-toggle::before {
            content: '';
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--text-tertiary);
        }

        .command-live-toggle.active {
            color: var(--success);
            border-color: rgba(48, 209, 88, 0.4);
            background: rgba(48, 209, 88, 0.1);
        }

        .command-live-toggle.active::before {
            background: var(--success);
        }

        .command-input-wrapper {
            display: flex;
            gap: 12px;
        }

        .command-input {
            flex: 1;
            padding: 14px 18px;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: var(--transition-fast);
        }

        .command-input::placeholder {
            color: var(--text-muted);
        }

        .command-input:focus {
            outline: none;
            border-color: var(--orion-primary);
            box-shadow: 0 0 0 3px var(--orion-glow);
        }

        .command-send {
            padding: 14px 24px;
            border: none;
            border-radius: var(--radius-lg);
            background: var(--orion-primary);
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .command-send:hover {
            background: #0066d6;
            transform: translateY(-1px);
        }

        .command-suggestions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .suggestion-chip {
            padding: 6px 12px;
            border: 1px solid var(--border-light);
            border-radius: 100px;
            background: transparent;
            color: var(--text-tertiary);
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .suggestion-chip:hover {
            background: var(--bg-glass-hover);
            color: var(--text-secondary);
        }

        .command-hint {
            margin-top: 10px;
            font-size: 11px;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .command-console {
            margin-top: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            max-height: 180px;
            overflow-y: auto;
            scroll-behavior: smooth;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .streamline-report {
            margin-top: 10px;
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
            padding: 9px 10px;
            display: grid;
            gap: 6px;
        }

        .streamline-head {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: 0.2px;
            margin-bottom: 2px;
        }

        .streamline-row {
            display: grid;
            grid-template-columns: 90px minmax(0, 1fr);
            gap: 8px;
            align-items: start;
        }

        .streamline-label {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--text-tertiary);
            letter-spacing: 0.35px;
        }

        .streamline-value {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .command-msg {
            padding: 8px 10px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            line-height: 1.45;
            border: 1px solid var(--border-subtle);
        }

        .command-msg.user {
            background: rgba(0, 122, 255, 0.12);
            border-color: rgba(0, 122, 255, 0.35);
            color: var(--text-primary);
        }

        .command-msg.system {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .command-msg.error {
            background: rgba(255, 69, 58, 0.12);
            border-color: rgba(255, 69, 58, 0.4);
            color: #ffd0cb;
        }

        .command-msg-head {
            font-size: 10px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.35px;
            margin-bottom: 4px;
        }

        /* Model Routing */
        .model-card {
            background: var(--bg-glass);
            backdrop-filter: blur(40px);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: 20px;
        }

        .model-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
        }

        .model-title {
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .model-top {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 12px;
            align-items: center;
            margin-bottom: 14px;
        }

        .model-budget {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }

        .model-budget .budget-value {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.1;
        }

        .model-budget .budget-sub {
            font-size: 11px;
            color: var(--text-tertiary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 14px;
        }

        .metric-box {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 10px;
            text-align: center;
        }

        .metric-box .metric-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .metric-box .metric-label {
            font-size: 10px;
            color: var(--text-tertiary);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .routing-events {
            max-height: 96px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .routing-event {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 8px 10px;
        }

        .routing-event-main {
            min-width: 0;
        }

        .routing-event-main .line-1 {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .routing-event-main .line-2 {
            font-size: 10px;
            color: var(--text-tertiary);
            margin-top: 2px;
        }

        .routing-event-latency {
            font-size: 11px;
            color: var(--text-tertiary);
            flex-shrink: 0;
        }

        .routing-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--success);
            flex-shrink: 0;
        }

        .routing-dot.fail {
            background: var(--danger);
        }

        /* Routing Advisor */
        .advisor-card {
            background: var(--bg-glass);
            backdrop-filter: blur(40px);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: 20px;
        }

        .advisor-header {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .advisor-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px;
        }

        .advisor-grid .wide {
            grid-column: span 2;
        }

        .advisor-select,
        .advisor-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 12px;
        }

        .advisor-select:focus,
        .advisor-input:focus {
            outline: none;
            border-color: var(--orion-primary);
        }

        .advisor-flags {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 8px;
            color: var(--text-tertiary);
            font-size: 11px;
        }

        .advisor-flags label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .advisor-run {
            margin-top: 10px;
            width: 100%;
            padding: 10px 14px;
            border: none;
            border-radius: var(--radius-sm);
            background: linear-gradient(135deg, var(--orion-primary), var(--orion-secondary));
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .advisor-run:hover {
            transform: translateY(-1px);
            filter: brightness(1.06);
        }

        .advisor-result {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.45;
        }

        .advisor-result strong {
            color: var(--text-primary);
        }

        /* Agent Fleet */
        .fleet-card {
            background: var(--bg-glass);
            backdrop-filter: blur(40px);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: 20px;
        }

        .fleet-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .fleet-title {
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fleet-count {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .fleet-command {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .fleet-control-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            background: rgba(0, 0, 0, 0.12);
        }

        .fleet-control-row label {
            font-size: 11px;
            color: var(--text-tertiary);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .fleet-control-row select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            padding: 6px 8px;
            font-size: 11px;
        }

        .fleet-control-check input {
            accent-color: var(--orion-primary);
        }

        .fleet-macros {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 6px;
            margin-bottom: 10px;
        }

        .fleet-macro-btn {
            border: 1px solid var(--border-light);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            padding: 8px 6px;
            font-size: 11px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .fleet-macro-btn:hover {
            color: var(--text-primary);
            background: var(--bg-glass-hover);
            transform: translateY(-1px);
        }

        .fleet-command select,
        .fleet-command input {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            padding: 9px 10px;
            font-size: 12px;
        }

        .fleet-command select {
            width: 34%;
            min-width: 120px;
        }

        .fleet-command input {
            flex: 1;
        }

        .fleet-command button {
            border: none;
            border-radius: var(--radius-sm);
            background: linear-gradient(135deg, var(--guardian-primary), #34C759);
            color: white;
            padding: 9px 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .fleet-command button:hover {
            transform: translateY(-1px);
            filter: brightness(1.06);
        }

        .fleet-batch {
            margin-top: 8px;
            border-top: 1px solid var(--border-subtle);
            padding-top: 8px;
        }

        .fleet-batch-title {
            font-size: 10px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 6px;
        }

        .fleet-target-checks {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            max-height: 64px;
            overflow-y: auto;
            margin-bottom: 8px;
        }

        .fleet-target-checks label {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 7px;
            border: 1px solid var(--border-subtle);
            border-radius: 100px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 10px;
            cursor: pointer;
        }

        .fleet-batch-row {
            display: flex;
            gap: 8px;
        }

        .fleet-batch-row input {
            flex: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            padding: 9px 10px;
            font-size: 11px;
        }

        .fleet-batch-row button {
            border: none;
            border-radius: var(--radius-sm);
            background: linear-gradient(135deg, var(--orion-primary), var(--orion-secondary));
            color: white;
            padding: 9px 12px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .fleet-batch-row button:hover {
            transform: translateY(-1px);
            filter: brightness(1.08);
        }

        .fleet-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px;
            max-height: 170px;
            overflow-y: auto;
        }

        .fleet-item {
            border: 1px solid var(--border-subtle);
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            padding: 10px;
        }

        .fleet-item-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .fleet-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.2px;
        }

        .fleet-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 10px;
            color: var(--text-tertiary);
        }

        .fleet-status::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--warning);
        }

        .fleet-status.online {
            color: var(--success);
        }

        .fleet-status.online::before {
            background: var(--success);
        }

        .fleet-status.paused {
            color: var(--warning);
        }

        .fleet-status.paused::before {
            background: var(--warning);
        }

        .fleet-last {
            font-size: 11px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .fleet-role {
            margin-top: 3px;
            font-size: 10px;
            color: var(--text-tertiary);
        }

        .fleet-meta {
            margin-top: 5px;
            font-size: 10px;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .fleet-actions {
            margin-top: 8px;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .fleet-act-btn {
            border: 1px solid var(--border-light);
            background: rgba(255, 255, 255, 0.02);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            padding: 4px 8px;
            font-size: 10px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .fleet-act-btn:hover {
            color: var(--text-primary);
            background: var(--bg-glass-hover);
        }

        .fleet-inline-command {
            margin-top: 8px;
            display: flex;
            gap: 6px;
        }

        .fleet-inline-command input {
            flex: 1;
            min-width: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            padding: 5px 7px;
            font-size: 10px;
        }

        .fleet-inline-command button {
            border: 1px solid var(--border-light);
            background: var(--bg-glass-hover);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            padding: 5px 8px;
            font-size: 10px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .fleet-inline-command button:hover {
            color: var(--text-primary);
        }

        /* Ops Stream */
        .ops-feed-card {
            background: var(--bg-glass);
            backdrop-filter: blur(40px);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .ops-feed-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .ops-feed-title {
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ops-feed-controls {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
        }

        .ops-feed-controls select,
        .ops-feed-controls button {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 11px;
            padding: 7px 8px;
        }

        .ops-feed-controls button {
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .ops-feed-controls button:hover {
            color: var(--text-primary);
            background: var(--bg-glass-hover);
        }

        .ops-feed-list {
            max-height: 220px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .ops-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 8px 10px;
        }

        .ops-item-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 3px;
            font-size: 10px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .ops-item-type {
            padding: 2px 6px;
            border-radius: 100px;
            border: 1px solid var(--border-subtle);
            color: var(--text-tertiary);
            background: var(--bg-glass);
        }

        .ops-item-message {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
            word-break: break-word;
        }

        /* Pending Decisions */
        .decisions-card {
            background: var(--bg-glass);
            backdrop-filter: blur(40px);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: 20px;
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .decisions-header {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .decisions-count {
            padding: 2px 8px;
            border-radius: 100px;
            background: var(--warning);
            color: black;
            font-size: 11px;
            font-weight: 600;
        }

        .decisions-list {
            flex: 1;
            overflow-y: auto;
        }

        .decision-item {
            padding: 16px;
            margin-bottom: 12px;
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
        }

        .decision-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .decision-action {
            font-size: 14px;
            font-weight: 500;
        }

        .decision-risk {
            padding: 4px 10px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 500;
        }

        .decision-risk.low { background: rgba(48, 209, 88, 0.15); color: var(--success); }
        .decision-risk.medium { background: rgba(255, 159, 10, 0.15); color: var(--warning); }
        .decision-risk.high { background: rgba(255, 69, 58, 0.15); color: var(--danger); }

        .decision-details {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-bottom: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .decision-actions {
            display: flex;
            gap: 8px;
        }

        .decision-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .decision-btn.approve {
            background: var(--success);
            color: white;
        }

        .decision-btn.decline {
            background: var(--bg-glass);
            border: 1px solid var(--border-light);
            color: var(--text-secondary);
        }

        .decision-btn:hover {
            transform: translateY(-1px);
        }

        /* ═════════════════════════════════════════════════════════
           SCROLLBAR
           ═════════════════════════════════════════════════════════ */

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }

        /* ═════════════════════════════════════════════════════════
           RESPONSIVE
           ═════════════════════════════════════════════════════════ */

        @media (max-width: 1200px) {
            .main {
                grid-template-columns: 1fr 1fr;
            }

            .guardian-panel {
                grid-column: span 2;
            }
        }

        @media (max-width: 768px) {
            .main {
                grid-template-columns: 1fr;
                padding: 72px 12px 12px;
            }

            .header {
                width: calc(100% - 24px);
            }

            .header-status {
                display: none;
            }

            .header-options {
                display: none;
            }

            .advisor-grid {
                grid-template-columns: 1fr;
            }

            .advisor-grid .wide {
                grid-column: span 1;
            }

            .metric-grid {
                grid-template-columns: 1fr;
            }

            .fleet-command {
                flex-direction: column;
            }

            .fleet-command select {
                width: 100%;
            }

            .fleet-control-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .fleet-grid {
                grid-template-columns: 1fr;
            }

            .fleet-macros {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .fleet-batch-row {
                flex-direction: column;
            }

            .ops-feed-controls {
                flex-direction: column;
            }

            .provider-actions {
                flex-direction: column;
                align-items: flex-start;
            }

            .provider-binding-row {
                grid-template-columns: 1fr;
            }
        }

        /* ═════════════════════════════════════════════════════════
           ANIMATIONS
           ═════════════════════════════════════════════════════════ */

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px var(--orion-glow); }
            50% { box-shadow: 0 0 40px var(--orion-glow), 0 0 60px var(--orion-glow); }
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Animated Background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }

        .bg-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.3;
            animation: float 20s ease-in-out infinite;
        }

        .bg-orb.orb-1 {
            width: 400px;
            height: 400px;
            background: var(--orion-primary);
            top: -100px;
            left: -100px;
            animation-delay: 0s;
        }

        .bg-orb.orb-2 {
            width: 300px;
            height: 300px;
            background: var(--guardian-primary);
            bottom: -50px;
            right: -50px;
            animation-delay: -5s;
        }

        .bg-orb.orb-3 {
            width: 250px;
            height: 250px;
            background: var(--cipher-primary);
            top: 50%;
            left: 50%;
            animation-delay: -10s;
        }

        .bg-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: float 30s ease-in-out infinite;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
            animation: float 3s ease-in-out infinite;
        }

        .empty-state-text {
            font-size: 14px;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 14px 20px;
            background: var(--bg-glass);
            backdrop-filter: blur(40px);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            max-width: 350px;
        }

        .toast.success { border-left: 3px solid var(--success); }
        .toast.warning { border-left: 3px solid var(--warning); }
        .toast.error { border-left: 3px solid var(--danger); }
        .toast.info { border-left: 3px solid var(--orion-primary); }

        .toast-icon { font-size: 18px; }
        .toast-message { font-size: 13px; color: var(--text-secondary); flex: 1; }
        .toast-close {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 4px;
        }

        /* Progress Ring */
        .progress-ring {
            position: relative;
            width: 60px;
            height: 60px;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 4;
        }

        .progress-ring .bg {
            stroke: var(--border-light);
        }

        .progress-ring .progress {
            stroke: var(--orion-primary);
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease-out;
        }

        .progress-ring .value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            font-weight: 600;
        }

        /* Mini Chart */
        .mini-chart {
            display: flex;
            align-items: flex-end;
            gap: 3px;
            height: 30px;
        }

        .mini-chart-bar {
            width: 6px;
            background: linear-gradient(to top, var(--orion-primary), var(--orion-secondary));
            border-radius: 2px;
            transition: height 0.3s ease-out;
        }

        /* Keyboard Shortcut Hints */
        .kbd {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 2px 6px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: var(--text-tertiary);
        }

        /* Loading Skeleton */
        .skeleton {
            background: linear-gradient(
                90deg,
                var(--bg-tertiary) 25%,
                var(--bg-glass-hover) 50%,
                var(--bg-tertiary) 75%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-sm);
        }

        /* Tooltip */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 11px;
            white-space: nowrap;
            z-index: 100;
            animation: fadeIn 0.2s ease-out;
        }

        /* Sparkline */
        .sparkline {
            stroke: var(--orion-primary);
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* Live indicator */
        .live-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(255, 59, 48, 0.15);
            border-radius: 100px;
            font-size: 11px;
            font-weight: 500;
            color: var(--danger);
        }

        .live-indicator::before {
            content: '';
            width: 6px;
            height: 6px;
            background: var(--danger);
            border-radius: 50%;
            animation: pulse 1s ease-in-out infinite;
        }

        .live-indicator.offline {
            background: rgba(255, 159, 10, 0.15);
            color: var(--warning);
        }

        .live-indicator.offline::before {
            background: var(--warning);
        }

        /* Enhanced stats with animation */
        .stat-value.animated {
            animation: scaleIn 0.5s ease-out;
        }

        .stat-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            margin-top: 4px;
        }

        .stat-trend.up { color: var(--success); }
        .stat-trend.down { color: var(--danger); }
    </style>
</head>
<body class="minimal-mode performance-mode">
    <!-- TOP NAVIGATION BAR -->
    <nav class="top-nav">
        <div class="nav-brand">
            <span class="nav-logo">N</span>
            <span class="nav-title">Nexus</span>
        </div>
        <div class="nav-links">
            <a href="#" class="nav-link active" data-page="dashboard" onclick="showPage('dashboard')">
                <span>📊</span> Dashboard
            </a>
            <a href="#" class="nav-link" data-page="tasks" onclick="showPage('tasks')">
                <span>📋</span> Tasks
            </a>
            <a href="#" class="nav-link" data-page="agents" onclick="showPage('agents')">
                <span>🤖</span> Agents
            </a>
            <a href="#" class="nav-link" data-page="chat" onclick="showPage('chat')">
                <span>💬</span> Chat
            </a>
        </div>
        <div class="nav-status">
            <span class="nav-iteration" id="nav-iteration">#0</span>
            <span class="nav-dot"></span>
        </div>
    </nav>

    <style>
        .top-nav {
            position: fixed; top: 0; left: 0; right: 0; height: 56px;
            background: rgba(26, 26, 46, 0.95); border-bottom: 1px solid #333;
            display: flex; align-items: center; padding: 0 20px; z-index: 10000;
            backdrop-filter: blur(10px);
        }
        .nav-brand { display: flex; align-items: center; gap: 10px; margin-right: 40px; }
        .nav-logo {
            width: 32px; height: 32px; background: linear-gradient(135deg, #00d4ff, #7b2ff7);
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 16px;
        }
        .nav-title { font-size: 18px; font-weight: 600; background: linear-gradient(90deg, #00d4ff, #7b2ff7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .nav-links { display: flex; gap: 8px; flex: 1; }
        .nav-link {
            padding: 8px 16px; border-radius: 8px; color: #888; text-decoration: none;
            font-size: 14px; display: flex; align-items: center; gap: 8px;
            transition: all 0.2s;
        }
        .nav-link:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-link.active { background: rgba(0, 212, 255, 0.15); color: #00d4ff; }
        .nav-status { display: flex; align-items: center; gap: 12px; }
        .nav-iteration { font-size: 14px; color: #00d4ff; font-weight: 600; }
        .nav-dot { width: 10px; height: 10px; background: #3fb950; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        body { padding-top: 56px; }
    </style>

    <script>
        function showPage(page) {
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`[data-page="${page}"]`)?.classList.add('active');
            // Hide all sections, show selected
            // This is simplified - in full implementation would toggle sections
        }
        // Update iteration in nav
        setInterval(() => {
            fetch('/api/status').then(r=>r.json()).then(d=>{
                const it = d.orion_instances?.[0]?.iteration || 0;
                document.getElementById('nav-iteration').textContent = '#' + it;
            });
        }, 5000);
    </script>

    <div class="bg-animation" aria-hidden="true">
        <div class="bg-orb orb-1"></div>
        <div class="bg-orb orb-2"></div>
        <div class="bg-orb orb-3"></div>
        <div class="bg-grid"></div>
    </div>
    <div class="toast-container" id="toast-container"></div>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-logo">
                <div class="header-logo-icon">N</div>
                <span class="header-logo-text">Nexus Control Center</span>
            </div>
            <div class="header-divider"></div>
            <div class="header-status">
                <div class="status-item">
                    <span class="status-dot orion"></span>
                    <span>ORION</span>
                </div>
                <div class="status-item">
                    <span class="status-dot guardian"></span>
                    <span>GUARDIAN</span>
                </div>
                <div class="status-item">
                    <span class="status-dot monitor"></span>
                    <span>MONITOR</span>
                </div>
            </div>
            <div class="header-divider"></div>
            <div class="header-actions">
                <div class="header-options">
                    <select id="instance-select" onchange="changeInstance(this.value)" title="Orion Instance">
                        <option value="orion-1">Orion 1</option>
                    </select>
                    <select id="theme-select" onchange="changeTheme(this.value)" title="Giao diện">
                        <option value="light">Sáng</option>
                        <option value="dark">Tối</option>
                    </select>
                    <select id="density-select" onchange="changeDensity(this.value)" title="Mức thông tin">
                        <option value="focus">Focus</option>
                        <option value="minimal">Tối giản</option>
                        <option value="full">Đầy đủ</option>
                    </select>
                    <select id="motion-select" onchange="changeMotion(this.value)" title="Hiệu năng">
                        <option value="fast">Tối ưu</option>
                        <option value="smooth">Mượt</option>
                    </select>
                    <select id="log-view-select" onchange="changeLogView(this.value)" title="Kiểu log">
                        <option value="smart">Log giá trị</option>
                        <option value="raw">Log chi tiết</option>
                    </select>
                </div>
                <button class="header-btn" onclick="toggleFullscreen()" title="Toàn màn hình">⛶</button>
                <button class="header-btn" onclick="openOpenClaw()" title="OpenClaw Control">🦞</button>
                <button class="header-btn" onclick="refreshDashboard()" title="Làm mới">↻</button>
                <button class="header-btn danger" onclick="emergencyShutdown()" title="Dừng khẩn cấp">⏻</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main">
            <!-- ORION Panel -->
            <section class="agent-panel orion">
                <div class="panel-header">
                    <div class="panel-title">
                        <div class="panel-icon">🌟</div>
                        <div>
                            <div class="panel-name">ORION</div>
                            <div class="panel-role">Điều phối dự án</div>
                        </div>
                    </div>
                    <span class="panel-badge active" id="orion-badge">Đang chạy</span>
                </div>
                <div class="thinking-section">
                    <div class="thinking-label">💭 Đang phân tích</div>
                    <div class="thinking-content" id="orion-thinking">Đang khởi tạo...</div>
                </div>
                <div class="logs-section">
                    <div class="logs-header">📋 Nhật ký hoạt động</div>
                    <div class="logs-container" id="orion-logs">
                        <div class="empty-state">
                            <div class="empty-state-icon">📡</div>
                            <div class="empty-state-text">Đang chờ hoạt động...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Center Panel -->
            <section class="center-panel">
                <!-- Project Card -->
                <div class="project-card">
                    <div class="project-header">
                        <div class="project-info">
                            <h2 id="project-name">Loading...</h2>
                            <div class="project-status" id="project-status">Initializing system...</div>
                        </div>
                        <div class="project-score">
                            <div class="score-value" id="project-score">0.0</div>
                            <div class="score-label">Điểm</div>
                            <svg viewBox="0 0 120 30" class="sparkline" aria-hidden="true">
                                <path id="score-sparkline-path" class="sparkline" d="M0,20 L20,18 L40,16 L60,14 L80,12 L100,11 L120,10"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="project-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="iteration-count">0</div>
                            <div class="stat-label">Vòng lặp</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="decisions-count">0</div>
                            <div class="stat-label">Quyết định</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="uptime">0m</div>
                            <div class="stat-label">Thời gian chạy</div>
                        </div>
                    </div>
                </div>

                <div class="flow-card">
                    <div class="flow-head">
                        <div class="flow-title">🧭 Luồng đang chạy</div>
                        <div class="flow-metrics">
                            <span class="flow-chip" id="flow-count-chip">0 luồng active</span>
                            <span class="flow-chip" id="agent-online-chip">0 agent online</span>
                            <span class="flow-chip" id="instance-count-chip">0 instance</span>
                            <span class="flow-chip" id="runtime-flow-chip">0 runtime flow</span>
                            <span class="flow-chip" id="computer-control-chip">Computer Control: OFF</span>
                            <span class="flow-chip" id="monitor-autopilot-chip">Autopilot: ON</span>
                            <span class="flow-chip" id="cost-guard-chip">Cost Guard: BALANCED</span>
                            <span class="flow-chip" id="rate-limit-chip">Rate Limit: NORMAL</span>
                            <button class="instance-btn" id="monitor-autopilot-btn" onclick="toggleMonitorAutopilot()">Tắt Autopilot</button>
                        </div>
                    </div>
                    <div class="instance-strip" id="instance-strip">
                        <div class="empty-state-text">Đang đồng bộ Orion instances...</div>
                    </div>
                    <div class="flow-list" id="flow-list">
                        <div class="empty-state-text">Đang đồng bộ trạng thái runtime...</div>
                    </div>
                </div>

                <div class="control-dock">
                    <div class="control-header">
                        <div>
                            <div class="control-title">🧭 Nexus Control Dock</div>
                            <div class="control-sub">Điều khiển trực tiếp Orion/Guardian/Monitor/Computer. Mọi thao tác đều log lại ở bảng lệnh.</div>
                        </div>
                        <div class="control-badges">
                            <span class="control-badge" id="control-instance-label">Instance: ORION-1</span>
                            <span class="control-badge" id="control-autopilot-label">Autopilot: ON</span>
                            <span class="control-badge" id="control-computer-label">Computer: OFF</span>
                            <span class="control-badge" id="control-cost-label">Cost: BALANCED</span>
                            <span class="control-badge" id="control-pending-label">Pending: 0</span>
                        </div>
                    </div>
                    <div class="control-grid">
                        <div class="control-group">
                            <div class="control-group-head">
                                <div>
                                    <div class="control-group-title">Orion Core</div>
                                    <div class="control-group-desc">Chu kỳ, trạng thái, tạm dừng/tiếp tục</div>
                                </div>
                                <span class="control-group-chip">core</span>
                            </div>
                            <div class="control-buttons">
                                <button class="control-btn primary" onclick="sendInstanceCommand('orion','status')">Status</button>
                                <button class="control-btn" onclick="sendInstanceCommand('orion','run_cycle')">Run 1 cycle</button>
                                <button class="control-btn warning" onclick="sendInstanceCommand('orion','pause')">Pause</button>
                                <button class="control-btn success" onclick="sendInstanceCommand('orion','resume')">Resume</button>
                            </div>
                        </div>
                        <div class="control-group">
                            <div class="control-group-head">
                                <div>
                                    <div class="control-group-title">Guardian & Monitor</div>
                                    <div class="control-group-desc">Gỡ kẹt, autopilot, can thiệp an toàn</div>
                                </div>
                                <span class="control-group-chip">safety</span>
                            </div>
                            <div class="control-buttons">
                                <button class="control-btn" onclick="sendInstanceGuardian(getSelectedInstance(),'unstick_orion')">Unstick Orion</button>
                                <button class="control-btn success" onclick="sendInstanceGuardian(getSelectedInstance(),'autopilot_on')">Guardian Auto ON</button>
                                <button class="control-btn warning" onclick="sendInstanceGuardian(getSelectedInstance(),'autopilot_off')">Guardian Auto OFF</button>
                                <button class="control-btn" onclick="toggleMonitorAutopilot()">Monitor Autopilot Toggle</button>
                            </div>
                        </div>
                        <div class="control-group">
                            <div class="control-group-head">
                                <div>
                                    <div class="control-group-title">Cost Guard</div>
                                    <div class="control-group-desc">Điều tiết token/cost theo chế độ chạy</div>
                                </div>
                                <span class="control-group-chip">budget</span>
                            </div>
                            <div class="control-buttons">
                                <button class="control-btn" onclick="setCostGuardMode('economy')">Economy</button>
                                <button class="control-btn primary" onclick="setCostGuardMode('balanced')">Balanced</button>
                                <button class="control-btn success" onclick="setCostGuardMode('aggressive')">Aggressive</button>
                                <button class="control-btn" onclick="loadCostGuard()">Refresh</button>
                            </div>
                            <div class="control-group-desc" id="cost-guard-desc">Đang đồng bộ chế độ cost guard...</div>
                        </div>
                        <div class="control-group">
                            <div class="control-group-head">
                                <div>
                                    <div class="control-group-title">Computer Actions</div>
                                    <div class="control-group-desc">Duyệt prompt hoặc từ chối ngay</div>
                                </div>
                                <span class="control-group-chip">direct</span>
                            </div>
                            <div class="control-buttons">
                                <button class="control-btn success" onclick="sendComputerAction('approve_prompt')">Approve (Y+Enter)</button>
                                <button class="control-btn danger" onclick="sendComputerAction('deny_prompt')">Deny (ESC)</button>
                                <button class="control-btn" onclick="sendComputerAction('continue_prompt')">Enter</button>
                                <button class="control-btn" onclick="pullProgressSnapshot()">Snapshot now</button>
                            </div>
                        </div>
                    </div>
                    <div class="control-footer">Tip: phản hồi hiển thị realtime ở console lệnh bên dưới.</div>
                </div>

                <div class="provider-card" id="provider-card">
                    <div class="provider-loading">Đang tải Provider Hub...</div>
                </div>

                <div class="agreement-card">
                    <div class="agreement-head">
                        <div>
                            <div class="agreement-title">🤝 Working Agreement</div>
                            <div class="agreement-sub">Cách Nexus vận hành theo quy trình của bạn.</div>
                        </div>
                        <div class="agreement-meta" id="agreement-updated">Chưa cập nhật</div>
                    </div>
                    <textarea class="agreement-textarea" id="agreement-text"
                              placeholder="Mỗi dòng là một nguyên tắc. Ví dụ: &#10;Ưu tiên tự động hóa end-to-end; chỉ hỏi khi rủi ro rất cao.&#10;Dashboard là nơi theo dõi chính; log mới nhất ở trên."></textarea>
                    <div class="agreement-actions">
                        <button class="agreement-btn ghost" onclick="loadUserProfile()">Tải lại</button>
                        <button class="agreement-btn" onclick="saveUserProfile()">Lưu</button>
                    </div>
                </div>

                <div class="insight-card">
                    <div class="insight-head">
                        <div class="insight-title">✨ AI Tóm Tắt Nhanh</div>
                        <div class="insight-mode" id="insight-mode-label">Ưu tiên giá trị</div>
                    </div>
                    <div class="insight-grid">
                        <div class="insight-block">
                            <div class="insight-label">Tín hiệu chính</div>
                            <div class="insight-value" id="insight-headline">Đang tổng hợp dữ liệu...</div>
                        </div>
                        <div class="insight-block">
                            <div class="insight-label">Điều cần biết</div>
                            <div class="insight-value" id="insight-summary">Chưa có tín hiệu nổi bật.</div>
                        </div>
                        <div class="insight-block">
                            <div class="insight-label">Hành động đề xuất</div>
                            <div class="insight-value" id="insight-action">Tiếp tục theo dõi luồng realtime.</div>
                        </div>
                        <div class="insight-block">
                            <div class="insight-label">Log đã lọc nhiễu</div>
                            <div class="insight-value" id="insight-noise">Đang tính toán...</div>
                        </div>
                        <div class="insight-block">
                            <div class="insight-label">Sự kiện giá trị</div>
                            <div class="insight-value" id="insight-key-events">Chưa có.</div>
                        </div>
                    </div>
                </div>

                <!-- Command Input -->
                <div class="command-card">
                    <div class="command-header">
                        <span class="command-title">🧭 Nexus Command</span>
                        <div class="command-head-actions">
                            <button class="command-live-toggle active" id="command-live-toggle" onclick="toggleCommandLive()">
                                Live Stream
                            </button>
                            <button class="voice-btn" id="voice-btn" onclick="toggleVoiceInput()">
                                <span class="voice-icon">🎤</span>
                                <span id="voice-text">Giọng nói</span>
                            </button>
                        </div>
                    </div>
                    <div class="command-input-wrapper">
                        <input type="text" class="command-input" id="command-input"
                               placeholder="Hỏi trạng thái, điều khiển flow, hoặc gõ lệnh ngắn..."
                               onkeypress="handleKeyPress(event)">
                        <button class="command-send" onclick="sendCommand()">Gửi</button>
                    </div>
                    <div class="command-suggestions">
                        <button class="suggestion-chip" onclick="quickCommand('tóm tắt trạng thái dự án hiện tại')">📊 Trạng thái</button>
                        <button class="suggestion-chip" onclick="quickCommand('bạn đang làm gì?')">❓ Việc hiện tại</button>
                        <button class="suggestion-chip" onclick="quickCommand('pause')">⏸ Pause Orion</button>
                        <button class="suggestion-chip" onclick="quickCommand('resume')">▶ Resume Orion</button>
                        <button class="suggestion-chip" onclick="quickCommand('guardian gỡ kẹt orion')">🛡️ Gỡ kẹt</button>
                        <button class="suggestion-chip" onclick="sendComputerAction('approve_prompt')">✅ Duyệt prompt</button>
                        <button class="suggestion-chip" onclick="sendComputerAction('deny_prompt')">🛑 Từ chối prompt</button>
                        <button class="suggestion-chip" onclick="sendComputerAction('continue_prompt')">↩︎ Enter</button>
                    </div>
                    <div class="command-hint">
                        <span>Phím tắt</span>
                        <span class="kbd">Enter</span>
                        <span>để gửi lệnh</span>
                    </div>
                    <div class="streamline-report" id="streamline-report">
                        <div class="streamline-head">🧾 Streamline Report</div>
                        <div class="streamline-row">
                            <span class="streamline-label">Trạng thái</span>
                            <span class="streamline-value" id="report-status">Đang chờ yêu cầu...</span>
                        </div>
                        <div class="streamline-row">
                            <span class="streamline-label">Tóm tắt</span>
                            <span class="streamline-value" id="report-summary">Hãy gửi câu hỏi để nhận report theo thời gian thực.</span>
                        </div>
                        <div class="streamline-row">
                            <span class="streamline-label">Điểm chính</span>
                            <span class="streamline-value" id="report-highlights">Chưa có.</span>
                        </div>
                        <div class="streamline-row">
                            <span class="streamline-label">Bước tiếp theo</span>
                            <span class="streamline-value" id="report-next">Dùng câu lệnh ngắn để điều khiển nhanh.</span>
                        </div>
                    </div>
                    <div class="command-console" id="command-console">
                        <div class="command-msg system">
                            <div class="command-msg-head">Hệ thống</div>
                            Phản hồi lệnh sẽ hiển thị realtime tại đây.
                        </div>
                    </div>
                </div>

                <!-- TASK QUEUE PANEL -->
                <div class="task-panel">
                    <div class="task-panel-header">
                        <span>📋 TASK QUEUE</span>
                        <button class="task-add-btn" onclick="showAddTaskModal()">+ New Task</button>
                    </div>
                    <div class="task-panel-body" id="task-panel-body">
                        <div class="task-loading">Loading tasks...</div>
                    </div>
                </div>

                <!-- Model Routing -->
                <div class="model-card">
                    <div class="model-header">
                        <div class="model-title">🧠 Điều phối mô hình</div>
                        <div class="live-indicator" id="routing-live-indicator">ROUTING</div>
                    </div>
                    <div class="model-top">
                        <div class="progress-ring">
                            <svg width="60" height="60" viewBox="0 0 60 60">
                                <circle class="circle bg" cx="30" cy="30" r="26"></circle>
                                <circle class="circle progress" id="budget-progress-circle" cx="30" cy="30" r="26" stroke-dasharray="163.36" stroke-dashoffset="163.36"></circle>
                            </svg>
                            <div class="value" id="budget-progress-value">0%</div>
                        </div>
                        <div class="model-budget">
                            <div class="budget-value" id="routing-live-model">-</div>
                            <div class="budget-sub" id="budget-summary">Budget $0 / $0</div>
                        </div>
                    </div>
                    <div class="metric-grid">
                        <div class="metric-box">
                            <div class="metric-value" id="routing-total-tokens">0</div>
                            <div class="metric-label">Tokens</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value" id="routing-total-calls">0</div>
                            <div class="metric-label">Calls</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value" id="routing-latency">0ms</div>
                            <div class="metric-label">Latency</div>
                        </div>
                    </div>
                    <div class="routing-events" id="routing-events">
                        <div class="empty-state-text">Đang chờ telemetry mô hình...</div>
                    </div>
                </div>

                <!-- Routing Advisor -->
                <div class="advisor-card">
                    <div class="advisor-header">⚙️ Gợi ý Router tác vụ</div>
                    <div class="advisor-grid">
                        <select class="advisor-select" id="advisor-task-type"></select>
                        <select class="advisor-select" id="advisor-complexity">
                            <option value="">Độ phức tạp: Tự động</option>
                            <option value="simple">Đơn giản</option>
                            <option value="medium" selected>Trung bình</option>
                            <option value="complex">Phức tạp</option>
                        </select>
                        <select class="advisor-select" id="advisor-importance">
                            <option value="low">Mức ưu tiên: Thấp</option>
                            <option value="normal" selected>Mức ưu tiên: Bình thường</option>
                            <option value="high">Mức ưu tiên: Cao</option>
                            <option value="critical">Mức ưu tiên: Khẩn cấp</option>
                        </select>
                        <input class="advisor-input" id="advisor-estimated-tokens" type="number" min="64" step="64" value="1200" placeholder="Ước tính token">
                    </div>
                    <div class="advisor-flags">
                        <label><input type="checkbox" id="advisor-prefer-speed"> Ưu tiên tốc độ</label>
                        <label><input type="checkbox" id="advisor-prefer-cost"> Ưu tiên chi phí</label>
                    </div>
                    <button class="advisor-run" onclick="runRoutingAdvisor()">Đề xuất mô hình tốt nhất</button>
                    <div class="advisor-result" id="advisor-result">
                        Đang chờ đề xuất...
                    </div>
                </div>

                <!-- Agent Fleet -->
                <div class="fleet-card">
                    <div class="fleet-header">
                        <div class="fleet-title">🛰 Tổ đội agent realtime</div>
                        <div class="fleet-count" id="fleet-count">0 online</div>
                    </div>
                    <div class="fleet-macros">
                        <button class="fleet-macro-btn" onclick="runMacroCommand('status')">Toàn bộ trạng thái</button>
                        <button class="fleet-macro-btn" onclick="runMacroCommand('pause')">Tạm dừng tất cả</button>
                        <button class="fleet-macro-btn" onclick="runMacroCommand('resume')">Tiếp tục tất cả</button>
                        <button class="fleet-macro-btn" onclick="runMacroCommand('run_cycle')">Chạy 1 vòng</button>
                    </div>
                    <div class="fleet-command">
                        <select id="fleet-target">
                            <option value="all">Tất cả agent</option>
                        </select>
                        <input id="fleet-command" type="text" placeholder="run_cycle / status / pause / lệnh tùy chỉnh">
                        <button onclick="sendAgentCommand()">Gửi lệnh</button>
                    </div>
                    <div class="fleet-control-row">
                        <label>
                            Chế độ điều khiển
                            <select id="fleet-control-mode">
                                <option value="interrupt" selected>Ngắt để điều khiển</option>
                                <option value="strict">Nghiêm ngặt</option>
                            </select>
                        </label>
                        <label class="fleet-control-check">
                            <input type="checkbox" id="fleet-resume-after" checked>
                            Tự tiếp tục ORION sau lệnh thủ công
                        </label>
                    </div>
                    <div class="fleet-batch">
                        <div class="fleet-batch-title">Gửi lệnh hàng loạt song song</div>
                        <div class="fleet-target-checks" id="fleet-target-checks"></div>
                        <div class="fleet-batch-row">
                            <input id="fleet-batch-command" type="text" placeholder="Lệnh cho các agent đã chọn">
                            <button onclick="sendBatchCommand()">Gửi hàng loạt</button>
                        </div>
                    </div>
                    <div class="fleet-grid" id="fleet-grid">
                        <div class="empty-state-text">Đang chờ agent hoạt động...</div>
                    </div>
                </div>

                <!-- Ops Feed -->
                <div class="ops-feed-card">
                    <div class="ops-feed-head">
                        <div class="ops-feed-title">📡 Luồng vận hành</div>
                        <div class="fleet-count" id="ops-feed-count">0 sự kiện</div>
                    </div>
                    <div class="ops-feed-controls">
                        <select id="ops-filter-agent"></select>
                        <select id="ops-filter-level">
                            <option value="all">Mọi cấp độ</option>
                            <option value="info">Thông tin</option>
                            <option value="success">Thành công</option>
                            <option value="warning">Cảnh báo</option>
                            <option value="error">Lỗi</option>
                        </select>
                        <button onclick="loadOpsFeed()">Làm mới</button>
                    </div>
                    <div class="ops-feed-list" id="ops-feed-list">
                        <div class="empty-state-text">Đang chờ dữ liệu sự kiện...</div>
                    </div>
                </div>

                <!-- Pending Decisions -->
                <div class="decisions-card">
                    <div class="decisions-header">
                        ⚖️ Quyết định chờ duyệt
                        <span class="decisions-count" id="pending-count">0</span>
                    </div>
                    <div class="decisions-list" id="decisions-list">
                        <div class="empty-state">
                            <div class="empty-state-icon">✅</div>
                            <div class="empty-state-text">Không có quyết định chờ duyệt</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- GUARDIAN Panel -->
            <section class="agent-panel guardian">
                <div class="panel-header">
                    <div class="panel-title">
                        <div class="panel-icon">🛡️</div>
                        <div>
                            <div class="panel-name">GUARDIAN</div>
                            <div class="panel-role">Giám sát</div>
                        </div>
                    </div>
                    <span class="panel-badge active" id="guardian-badge">Đang giám sát</span>
                </div>
                <div class="thinking-section">
                    <div class="thinking-label">💭 Đang phân tích</div>
                    <div class="thinking-content" id="guardian-thinking">Đang giám sát toàn bộ hoạt động...</div>
                </div>
                <div class="logs-section">
                    <div class="logs-header">📋 Nhật ký quyết định</div>
                    <div class="logs-container" id="guardian-logs">
                        <div class="empty-state">
                            <div class="empty-state-icon">🛡️</div>
                            <div class="empty-state-text">Đang theo dõi quyết định...</div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // ═════════════════════════════════════════════════════════
        // CONTROL CENTER - JavaScript
        // ═════════════════════════════════════════════════════════

        const DASHBOARD_ACCESS_TOKEN = (() => {
            try {
                const queryToken = String(new URLSearchParams(window.location.search).get('token') || '').trim();
                const storedToken = String(localStorage.getItem('dashboard_access_token') || '').trim();
                const resolved = queryToken || storedToken;
                if (resolved) {
                    localStorage.setItem('dashboard_access_token', resolved);
                    if (queryToken && window.history && typeof window.history.replaceState === 'function') {
                        const url = new URL(window.location.href);
                        url.searchParams.delete('token');
                        window.history.replaceState({}, document.title, url.toString());
                    }
                }
                return resolved;
            } catch (error) {
                console.warn('Failed to read dashboard token:', error);
                return '';
            }
        })();

        const socket = io({
            auth: DASHBOARD_ACCESS_TOKEN ? { token: DASHBOARD_ACCESS_TOKEN } : {},
            query: DASHBOARD_ACCESS_TOKEN ? { token: DASHBOARD_ACCESS_TOKEN } : {},
        });

        const nativeFetch = window.fetch.bind(window);
        window.fetch = (input, init = {}) => {
            if (!DASHBOARD_ACCESS_TOKEN) {
                return nativeFetch(input, init);
            }
            const headers = new Headers(init.headers || {});
            if (!headers.has('X-Dashboard-Token')) {
                headers.set('X-Dashboard-Token', DASHBOARD_ACCESS_TOKEN);
            }
            return nativeFetch(input, { ...init, headers });
        };

        let state = {
            orion: { logs: [], thinking: '', status: {} },
            guardian: { logs: [], thinking: '', status: {} },
            project: { name: 'Nexus', status: 'Initializing', score: 0 },
            pendingDecisions: [],
            agentFleet: [],
            orionInstances: [],
            selectedInstanceId: 'orion-1',
            monitorSupervisor: { enabled: true },
            computerControl: { available: false, enabled: false, provider: 'unavailable' },
            costGuard: { mode: 'balanced', profile: {}, updated_at: null },
            agentControls: {},
            agentLogs: {},
            agentActivity: null,
            opsFeed: [],
            opsDigest: null,
            commandHistory: [],
            chatHandledIds: {},
            logView: 'smart',
            insight: {
                headline: 'Đang tổng hợp dữ liệu...',
                summary: 'Chưa có tín hiệu nổi bật.',
                action: 'Tiếp tục theo dõi luồng realtime.',
                noise: 'Đang tính toán...',
                key_events: 'Chưa có.',
            },
            commandLive: true,
            commandContext: { active: false, issuedAt: 0, targets: [] },
            liveNarration: { lastKey: '', lastAt: 0 },
            chatReport: {
                status: 'Đang chờ yêu cầu...',
                summary: 'Hãy gửi câu hỏi để nhận report theo thời gian thực.',
                highlights: [],
                next_action: 'Dùng câu lệnh ngắn để điều khiển nhanh.',
            },
            modelRouting: null,
            runtime: {},
            providerCatalog: null,
            providerProfile: null,
            providerDirty: false,
            systemSlo: null,
            scoreHistory: [0],
            userProfile: null,
            startTime: Date.now()
        };

        const AGENT_ROLE_LABELS = {
            orion: 'Điều phối tổng thể',
            guardian: 'Giám sát & phục hồi',
            nova: 'Sinh mã',
            pixel: 'UI/UX',
            echo: 'Test tự động',
            cipher: 'Bảo mật',
            flux: 'Deploy',
        };

        let isRecording = false;
        let recognition = null;
        let fleetRenderScheduled = false;
        let flowRenderScheduled = false;
        let orionLogsRenderScheduled = false;
        let guardianLogsRenderScheduled = false;
        let opsFeedRenderScheduled = false;
        let commandRenderScheduled = false;
        let insightRenderScheduled = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializePreferences();
            initSocket();
            initVoiceRecognition();
            initRoutingAdvisor();
            loadInitialState();
            loadUserProfile();
            loadAgentsStatus();
            loadOrionInstances();
            loadAgentActivity();
            loadMonitorAutopilot();
            loadComputerControlStatus();
            refreshOpenClawStatus();
            loadCostGuard();
            loadProviderCatalog();
            loadProviderProfile(true);
            loadModelRoutingStatus();
            loadRoutingEvents();
            loadOpsFeed();
            loadOpsDigest();
            loadSystemSlo();
            scheduleInsightRender();
            startUptimeCounter();
            syncCommandLiveToggle();
            applyChatReport(state.chatReport);
            setInterval(loadAgentsStatus, 20000);
            setInterval(loadOrionInstances, 25000);
            setInterval(loadAgentActivity, 20000);
            setInterval(loadMonitorAutopilot, 15000);
            setInterval(loadComputerControlStatus, 15000);
            setInterval(refreshOpenClawStatus, 15000);
            setInterval(loadCostGuard, 20000);
            setInterval(() => loadProviderProfile(false), 25000);
            setInterval(loadModelRoutingStatus, 12000);
            setInterval(loadRoutingEvents, 12000);
            setInterval(loadOpsFeed, 12000);
            setInterval(loadOpsDigest, 12000);
            setInterval(loadSystemSlo, 10000);
            setInterval(scheduleInsightRender, 12000);

            const fleetInput = document.getElementById('fleet-command');
            if (fleetInput) {
                fleetInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        sendAgentCommand();
                    }
                });
            }

            const batchInput = document.getElementById('fleet-batch-command');
            if (batchInput) {
                batchInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        sendBatchCommand();
                    }
                });
            }

            document.getElementById('ops-filter-agent')?.addEventListener('change', () => loadOpsFeed());
            document.getElementById('ops-filter-level')?.addEventListener('change', () => loadOpsFeed());
        });

        // Socket.IO
        function initSocket() {
            socket.on('connect', () => {
                console.log('Connected to server');
                socket.emit('request_status');
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from server');
            });

            socket.on('status_update', (data) => {
                updateState(data);
            });

            socket.on('orion_log', (log) => {
                addOrionLog(log);
            });

            socket.on('guardian_log', (log) => {
                addGuardianLog(log);
            });

            socket.on('agent_log', (payload) => {
                addAgentLog(payload);
                const entry = payload?.entry;
                if (entry) {
                    addOpsEvent({
                        timestamp: entry.timestamp,
                        type: 'agent_log',
                        agent: payload.agent || entry.agent,
                        level: entry.level || 'info',
                        message: entry.message || '',
                    });
                }
            });

            socket.on('agents_registered', (payload) => {
                if (Array.isArray(payload?.agents)) {
                    updateAgentTargets(payload.agents);
                }
            });

            socket.on('orion_thinking', (data) => {
                updateOrionThinking(data.thinking);
            });

            socket.on('guardian_thinking', (data) => {
                updateGuardianThinking(data.thinking);
            });

            socket.on('new_decision', (decision) => {
                state.pendingDecisions.push(decision);
                updateDecisions();
                addOpsEvent({
                    timestamp: decision.timestamp,
                    type: 'decision_pending',
                    agent: 'guardian',
                    level: 'warning',
                    message: `Pending decision: ${decision.action || 'unknown'}`,
                });
            });

            socket.on('decision_updated', (decision) => {
                state.pendingDecisions = state.pendingDecisions.filter(d => d.id !== decision.id);
                updateDecisions();
                addOpsEvent({
                    timestamp: decision.timestamp || new Date().toISOString(),
                    type: 'decision_history',
                    agent: 'guardian',
                    level: decision.decision === 'approved' ? 'success' : 'error',
                    message: `Decision ${decision.decision || 'updated'}: ${decision.action || 'unknown'}`,
                });
            });

            socket.on('project_status', (status) => {
                state.project = { ...state.project, ...status };
                updateProjectUI();
            });

            socket.on('chat_stream', (payload) => {
                handleChatStream(payload);
            });

            socket.on('runtime_heartbeat', (payload) => {
                if (!payload || typeof payload !== 'object') return;
                if (payload.runtime && typeof payload.runtime === 'object') {
                    state.runtime = payload.runtime;
                    if (payload.runtime.cost_guard && typeof payload.runtime.cost_guard === 'object') {
                        state.costGuard = payload.runtime.cost_guard;
                    }
                    if (payload.runtime.agent_controls && typeof payload.runtime.agent_controls === 'object') {
                        state.agentControls = payload.runtime.agent_controls;
                    }
                    syncProviderProfileFromRuntime(payload.runtime.provider_profile);
                    updateRuntimeBadges(state.runtime);
                }
                if (Array.isArray(payload.instances)) {
                    state.orionInstances = payload.instances;
                }
                if (payload.activity && typeof payload.activity === 'object') {
                    state.agentActivity = payload.activity;
                    if (payload.activity.agent_controls && typeof payload.activity.agent_controls === 'object') {
                        state.agentControls = payload.activity.agent_controls;
                    }
                    maybeNarrateAgentActivity(payload.activity);
                }
                scheduleFleetRender();
                scheduleFlowRender();
                renderInstanceStrip();
                renderCostGuard();
                renderProviderHub();
            });
        }

        // Load initial state
        async function loadInitialState() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                updateState(data);
            } catch (error) {
                console.error('Failed to load state:', error);
            }
        }

        async function loadUserProfile() {
            try {
                const response = await fetch('/api/user/profile');
                const data = await response.json();
                if (data?.profile) {
                    state.userProfile = data.profile;
                    renderUserProfile(data.profile);
                }
            } catch (error) {
                console.error('Failed to load user profile:', error);
            }
        }

        function renderUserProfile(profile) {
            const textarea = document.getElementById('agreement-text');
            const meta = document.getElementById('agreement-updated');
            if (!textarea) return;
            const agreement = Array.isArray(profile?.working_agreement)
                ? profile.working_agreement
                : [];
            textarea.value = agreement.join('\n');
            if (meta) {
                const updated = profile?.updated_at
                    ? new Date(profile.updated_at).toLocaleString()
                    : 'Chưa cập nhật';
                meta.textContent = `Cập nhật: ${updated}`;
            }
        }

        function extractAgreementLines(text) {
            return String(text || '')
                .split('\n')
                .map(line => line.trim())
                .filter(Boolean)
                .map(line => line.replace(/^[-•*—–\s]+/, '').trim())
                .filter(Boolean);
        }

        async function saveUserProfile() {
            const textarea = document.getElementById('agreement-text');
            if (!textarea) return;
            const lines = extractAgreementLines(textarea.value);
            try {
                const response = await fetch('/api/user/profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ working_agreement: lines })
                });
                const data = await response.json();
                if (data?.profile) {
                    state.userProfile = data.profile;
                    renderUserProfile(data.profile);
                    showToast('success', 'Đã lưu Working Agreement');
                } else {
                    showToast('error', data?.error || 'Không lưu được');
                }
            } catch (error) {
                console.error('Failed to save user profile:', error);
                showToast('error', 'Không thể lưu Working Agreement');
            }
        }

        // Update state
        function updateState(data) {
            state.orion = data.orion || state.orion;
            state.guardian = data.guardian || state.guardian;
            state.project = { ...state.project, ...data.project };
            state.pendingDecisions = data.pending_decisions || [];
            state.agentFleet = data.agent_fleet || state.agentFleet;
            state.orionInstances = data.orion_instances || state.orionInstances;
            state.monitorSupervisor = data.monitor_supervisor || state.monitorSupervisor;
            state.computerControl = data.computer_control || state.computerControl;
            state.agentLogs = data.agent_logs || state.agentLogs;
            state.modelRouting = data.model_routing || state.modelRouting;
            state.runtime = data.runtime || state.runtime;
            if (state.runtime?.cost_guard && typeof state.runtime.cost_guard === 'object') {
                state.costGuard = state.runtime.cost_guard;
            }
            if (state.runtime?.agent_controls && typeof state.runtime.agent_controls === 'object') {
                state.agentControls = state.runtime.agent_controls;
            }
            syncProviderProfileFromRuntime(state.runtime?.provider_profile);

            scheduleOrionLogsRender();
            scheduleGuardianLogsRender();
            updateOrionThinking(state.orion.thinking);
            updateGuardianThinking(state.guardian.thinking);
            updateProjectUI();
            updateDecisions();
            scheduleFleetRender();
            scheduleFlowRender();
            renderInstanceStrip();
            renderMonitorAutopilot();
            renderComputerControlStatus();
            scheduleInsightRender();
            if (state.runtime) {
                updateRuntimeBadges(state.runtime);
            }
            if (state.modelRouting) {
                updateModelRoutingUI(state.modelRouting);
            }
            renderCostGuard();
            renderProviderHub();
        }

        function updateRuntimeBadges(runtime) {
            const orionBadge = document.getElementById('orion-badge');
            if (orionBadge) {
                if (runtime.paused) {
                    orionBadge.textContent = 'Tạm dừng';
                    orionBadge.classList.remove('active');
                } else if (runtime.running) {
                    orionBadge.textContent = 'Đang chạy';
                    orionBadge.classList.add('active');
                } else {
                    orionBadge.textContent = 'Rảnh';
                    orionBadge.classList.remove('active');
                }
            }
        }

        function initializePreferences() {
            const legacyFocus = localStorage.getItem('dashboard_focus_mode');
            const legacyPerf = localStorage.getItem('dashboard_performance_mode');

            const theme = localStorage.getItem('autodev-theme') || localStorage.getItem('dashboard_theme') || 'light';
            const density = localStorage.getItem('dashboard_density')
                || (legacyFocus === 'false' ? 'full' : 'minimal');
            const motion = localStorage.getItem('dashboard_motion')
                || (legacyPerf === 'false' ? 'smooth' : 'fast');
            const logView = localStorage.getItem('dashboard_log_view') || 'smart';

            applyTheme(theme);
            applyDensity(density);
            applyMotion(motion);
            applyLogView(logView);
            syncPreferenceControls();
        }

        function applyTheme(theme) {
            const resolved = theme === 'dark' ? 'dark' : 'light';
            document.body.classList.toggle('theme-dark', resolved === 'dark');
            localStorage.setItem('dashboard_theme', resolved);
            localStorage.setItem('autodev-theme', resolved);
            document.body.setAttribute('data-theme', resolved);
        }

        function applyDensity(density) {
            const resolved = density === 'full'
                ? 'full'
                : (density === 'focus' ? 'focus' : 'minimal');
            document.body.classList.toggle('minimal-mode', resolved === 'minimal');
            document.body.classList.toggle('focus-mode', resolved === 'focus');
            localStorage.setItem('dashboard_density', resolved);
        }

        function applyMotion(mode) {
            const resolved = mode === 'smooth' ? 'smooth' : 'fast';
            document.body.classList.toggle('performance-mode', resolved === 'fast');
            localStorage.setItem('dashboard_motion', resolved);
        }

        function applyLogView(mode) {
            const resolved = mode === 'raw' ? 'raw' : 'smart';
            state.logView = resolved;
            localStorage.setItem('dashboard_log_view', resolved);
            scheduleOrionLogsRender();
            scheduleGuardianLogsRender();
            scheduleOpsFeedRender();
            scheduleInsightRender();
        }

        function changeTheme(theme) {
            applyTheme(theme);
            syncPreferenceControls();
        }

        function changeDensity(density) {
            applyDensity(density);
            syncPreferenceControls();
        }

        function changeMotion(mode) {
            applyMotion(mode);
            syncPreferenceControls();
        }

        function changeLogView(mode) {
            applyLogView(mode);
            syncPreferenceControls();
        }

        function syncPreferenceControls() {
            const theme = document.body.classList.contains('theme-dark') ? 'dark' : 'light';
            const density = document.body.classList.contains('focus-mode')
                ? 'focus'
                : (document.body.classList.contains('minimal-mode') ? 'minimal' : 'full');
            const motion = document.body.classList.contains('performance-mode') ? 'fast' : 'smooth';
            const logView = state.logView === 'raw' ? 'raw' : 'smart';
            const themeSelect = document.getElementById('theme-select');
            const densitySelect = document.getElementById('density-select');
            const motionSelect = document.getElementById('motion-select');
            const logViewSelect = document.getElementById('log-view-select');
            if (themeSelect) themeSelect.value = theme;
            if (densitySelect) densitySelect.value = density;
            if (motionSelect) motionSelect.value = motion;
            if (logViewSelect) logViewSelect.value = logView;
            const insightMode = document.getElementById('insight-mode-label');
            if (insightMode) {
                insightMode.textContent = logView === 'raw' ? 'Chi tiết đầy đủ' : 'Ưu tiên giá trị';
            }
        }

        // Voice Recognition
        function initVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'vi-VN';

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('command-input').value = transcript;
                    sendCommand();
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    stopVoiceRecording();
                };

                recognition.onend = () => {
                    stopVoiceRecording();
                };
            }
        }

        function toggleVoiceInput() {
            if (isRecording) {
                stopVoiceRecording();
            } else {
                startVoiceRecording();
            }
        }

        function startVoiceRecording() {
            if (recognition) {
                isRecording = true;
                recognition.start();
                const btn = document.getElementById('voice-btn');
                btn.classList.add('recording');
                document.getElementById('voice-text').textContent = 'Đang nghe...';
            }
        }

        function stopVoiceRecording() {
            isRecording = false;
            if (recognition) {
                recognition.stop();
            }
            const btn = document.getElementById('voice-btn');
            btn.classList.remove('recording');
            document.getElementById('voice-text').textContent = 'Giọng nói';
        }

        // Commands
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendCommand();
            }
        }

        async function sendCommand() {
            const input = document.getElementById('command-input');
            const command = input.value.trim();

            if (!command) return;

            input.value = '';
            pushCommandMessage('user', command);
            rememberCommandContext(['orion', 'guardian'], command);
            const instanceId = getSelectedInstance();
            const pendingId = `pending:${Date.now()}`;
            upsertCommandMessage(pendingId, 'assistant', '🤖 Đang xử lý yêu cầu, vui lòng chờ realtime stream...', 'system');

            try {
                const response = await fetch('/api/chat/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: command,
                        instance_id: instanceId,
                    })
                });

                const data = await response.json();
                if (data.success) {
                    if (data.instance_id) {
                        state.selectedInstanceId = String(data.instance_id);
                        syncInstanceSelect();
                    }
                    applyChatReport(data.report);
                    if (data.message_id && !state.chatHandledIds[data.message_id] && data.reply) {
                        state.chatHandledIds[data.message_id] = true;
                        pushCommandMessage('assistant', data.reply, 'system');
                    }
                    upsertCommandMessage(pendingId, 'assistant', '✅ Đã nhận phản hồi từ hệ thống.', 'system');
                    showToast(data.executed ? 'success' : 'info', data.executed ? 'Đã thực thi flow' : 'Đã trả lời');
                } else {
                    showToast('error', data.error || 'Không xử lý được yêu cầu');
                    pushCommandMessage('assistant', data.error || 'Không thể trả lời yêu cầu', 'error');
                    upsertCommandMessage(pendingId, 'assistant', `❌ ${data.error || 'Không xử lý được yêu cầu'}`, 'error');
                }
            } catch (error) {
                console.error('Failed to send command:', error);
                showToast('error', 'Không thể gửi lệnh');
                pushCommandMessage('assistant', `Yêu cầu thất bại: ${error.message || error}`, 'error');
                upsertCommandMessage(pendingId, 'assistant', `❌ Yêu cầu thất bại: ${error.message || error}`, 'error');
            }
        }

        function handleChatStream(payload) {
            if (!payload || !payload.message_id) return;
            const id = String(payload.message_id);
            const phase = String(payload.phase || '');
            const text = String(payload.text || '').trim();

            if (!text) return;
            if (payload.report) applyChatReport(payload.report);
            if (phase === 'final') {
                if (state.chatHandledIds[id]) return;
                state.chatHandledIds[id] = true;
                upsertCommandMessage(`stream:${id}`, 'assistant', text, 'system');
                return;
            }
            const phaseLabels = {
                thinking: 'Đang nghĩ',
                routing: 'Đang định tuyến',
                processing: 'Đang xử lý',
                report: 'Đang cập nhật report',
            };
            const label = phaseLabels[phase] || 'Đang xử lý';
            upsertCommandMessage(`stream:${id}`, 'assistant', `🤖 ${label}: ${text}`, 'system');
        }

        function quickCommand(command) {
            document.getElementById('command-input').value = command;
            sendCommand();
        }

        // Task Queue Functions - IMPROVED
        let taskModalOpen = false;

        async function loadTasks() {
            try {
                const resp = await fetch('/api/hub/kanban');
                const data = await resp.json();
                if (data.success) {
                    renderTasks(data.board);
                    // Update metrics
                    const m = data.metrics;
                    if (m) {
                        document.getElementById('task-stats-todo').textContent = (board.todo || []).length;
                        document.getElementById('task-stats-progress').textContent = (board.in_progress || []).length;
                        document.getElementById('task-stats-done').textContent = (board.done || []).length;
                    }
                }
            } catch(e) {
                console.error('Failed to load tasks:', e);
            }
        }

        function renderTasks(board) {
            const container = document.getElementById('task-panel-body');
            if (!container) return;

            // Show all tasks with status
            const allTasks = [
                ...(board.backlog || []).map(t => ({...t, _status: 'backlog'})),
                ...(board.todo || []).map(t => ({...t, _status: 'todo'})),
                ...(board.in_progress || []).map(t => ({...t, _status: 'in_progress'})),
                ...(board.review || []).map(t => ({...t, _status: 'review'})),
                ...(board.done || []).map(t => ({...t, _status: 'done'}))
            ];

            if (allTasks.length === 0) {
                container.innerHTML = '<div class="task-empty"><div class="task-empty-icon">📋</div>No tasks yet.<br>Click "+ New Task" to create one!</div>';
                return;
            }

            container.innerHTML = allTasks.map(task => `
                <div class="task-item ${task._status === 'done' ? 'completed' : ''}" onclick="moveTask('${task.id}')">
                    <div class="task-item-left">
                        <div class="task-item-check"></div>
                        <span class="task-item-title">${escapeHtml(task.title)}</span>
                    </div>
                    <span class="task-item-priority task-priority-${task.priority}">${task.priority}</span>
                </div>
            `).join('');
        }

        async function moveTask(taskId) {
            // Cycle through statuses: todo -> in_progress -> review -> done
            try {
                await fetch(`/api/hub/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ status: 'in_progress' })
                });
                loadTasks();
            } catch(e) {
                console.error('Failed to move task:', e);
            }
        }

        function showAddTaskModal() {
            if (taskModalOpen) return;
            taskModalOpen = true;

            // Create modal
            const modal = document.createElement('div');
            modal.id = 'task-modal';
            modal.className = 'modal-overlay open';
            modal.innerHTML = `
                <div class="modal" style="width: 400px;">
                    <div class="modal-header" style="padding: 16px 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 16px;">➕ New Task</h3>
                        <button onclick="closeTaskModal()" style="background: none; border: none; color: #888; font-size: 24px; cursor: pointer;">×</button>
                    </div>
                    <div style="padding: 20px;">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 12px; color: #888; margin-bottom: 6px;">Task Title</label>
                            <input type="text" id="new-task-title" placeholder="What needs to be done?" style="width: 100%; padding: 12px; background: #21262d; border: 1px solid #333; border-radius: 8px; color: white; font-size: 14px;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-size: 12px; color: #888; margin-bottom: 6px;">Priority</label>
                            <select id="new-task-priority" style="width: 100%; padding: 12px; background: #21262d; border: 1px solid #333; border-radius: 8px; color: white; font-size: 14px;">
                                <option value="low">Low - Can wait</option>
                                <option value="medium" selected>Medium - Normal</option>
                                <option value="high">High - Important</option>
                                <option value="urgent">Urgent - Critical</option>
                            </select>
                        </div>
                        <button onclick="submitNewTask()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #00d4ff, #7b2ff7); border: none; border-radius: 8px; color: white; font-size: 14px; font-weight: 600; cursor: pointer;">Create Task</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Focus input
            setTimeout(() => {
                document.getElementById('new-task-title').focus();
            }, 100);
        }

        function closeTaskModal() {
            taskModalOpen = false;
            document.getElementById('task-modal')?.remove();
        }

        async function submitNewTask() {
            const title = document.getElementById('new-task-title').value.trim();
            const priority = document.getElementById('new-task-priority').value;

            if (!title) {
                document.getElementById('new-task-title').focus();
                return;
            }

            try {
                await fetch('/api/hub/tasks', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ title, priority })
                });
                closeTaskModal();
                loadTasks();
            } catch(e) {
                console.error('Failed to create task:', e);
            }
        }

        // Load tasks on start
        loadTasks();
        setInterval(loadTasks, 8000);

        // Decisions
        async function approveDecision(decisionId) {
            try {
                const response = await fetch('/api/decision/approve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ decision_id: decisionId })
                });
                const data = await response.json();
                if (data?.execution) {
                    const execution = data.execution;
                    const outcome = execution.success ? 'thành công' : 'không chạy được';
                    const output = truncateText(String(execution.output || execution.error || ''), 260);
                    pushCommandMessage('system', `Guardian duyệt lệnh (${outcome}): ${output}`, execution.success ? 'system' : 'error');
                    applyChatReport({
                        status: execution.success ? 'Đã thực thi' : 'Duyệt nhưng bị chặn',
                        summary: execution.success ? 'Guardian đã chạy lệnh được duyệt.' : 'Lệnh được duyệt nhưng không đạt điều kiện an toàn.',
                        highlights: [
                            `Command: ${execution.command || 'n/a'}`,
                            execution.success ? `Return code: ${execution.returncode}` : `Lý do: ${execution.error || 'unknown'}`,
                        ],
                        next_action: execution.success ? 'Kiểm tra output và tiếp tục quy trình.' : 'Điều chỉnh command rồi gửi lại.',
                    });
                }
            } catch (error) {
                console.error('Failed to approve:', error);
            }
        }

        async function declineDecision(decisionId) {
            try {
                const response = await fetch('/api/decision/decline', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ decision_id: decisionId })
                });
                const data = await response.json();
                if (data?.success) {
                    pushCommandMessage('system', 'Guardian: đã từ chối quyết định theo thao tác của bạn.', 'system');
                    applyChatReport({
                        status: 'Đã từ chối',
                        summary: 'Quyết định đã bị từ chối thủ công.',
                        highlights: ['Không có command nào được thực thi.'],
                        next_action: 'Bạn có thể gửi command thay thế an toàn hơn.',
                    });
                }
            } catch (error) {
                console.error('Failed to decline:', error);
            }
        }

        // UI Updates
        function updateOrionLogs() {
            const container = document.getElementById('orion-logs');
            const sourceLogs = state.logView === 'raw'
                ? state.orion.logs
                : filterValuableLogs(state.orion.logs);
            const displayLogs = state.logView === 'raw'
                ? sortLogsNewestFirst(sourceLogs).slice(0, 20)
                : compressLogsForDisplay(sourceLogs, 12);
            if (sourceLogs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📡</div>
                        <div class="empty-state-text">Không có tín hiệu quan trọng gần đây.</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = displayLogs.map(log => `
                <div class="log-entry ${log.level}">
                    <div class="log-time">${formatTime(log.timestamp)}</div>
                    <div class="log-message">${escapeHtml(log.message)}</div>
                </div>
            `).join('');

            container.scrollTop = 0;
        }

        function updateGuardianLogs() {
            const container = document.getElementById('guardian-logs');
            const sourceLogs = state.logView === 'raw'
                ? state.guardian.logs
                : filterValuableLogs(state.guardian.logs);
            const displayLogs = state.logView === 'raw'
                ? sortLogsNewestFirst(sourceLogs).slice(0, 20)
                : compressLogsForDisplay(sourceLogs, 12);
            if (sourceLogs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🛡️</div>
                        <div class="empty-state-text">Không có tín hiệu giám sát quan trọng.</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = displayLogs.map(log => `
                <div class="log-entry ${log.level}">
                    <div class="log-time">${formatTime(log.timestamp)}</div>
                    <div class="log-message">${escapeHtml(log.message)}</div>
                </div>
            `).join('');

            container.scrollTop = 0;
        }

        function addOrionLog(log) {
            state.orion.logs.push(log);
            if (state.orion.logs.length > 100) {
                state.orion.logs = state.orion.logs.slice(-100);
            }
            scheduleOrionLogsRender();
        }

        function addGuardianLog(log) {
            state.guardian.logs.push(log);
            if (state.guardian.logs.length > 100) {
                state.guardian.logs = state.guardian.logs.slice(-100);
            }
            scheduleGuardianLogsRender();
        }

        function updateOrionThinking(thinking) {
            state.orion.thinking = thinking;
            const container = document.getElementById('orion-thinking');
            container.textContent = thinking || 'Đang phân tích dự án...';
        }

        function updateGuardianThinking(thinking) {
            state.guardian.thinking = thinking;
            const container = document.getElementById('guardian-thinking');
            container.textContent = thinking || 'Đang giám sát toàn bộ hoạt động...';
        }

        function updateProjectUI() {
            document.getElementById('project-name').textContent = state.project.name || 'Chưa có dự án';
            document.getElementById('project-status').textContent = state.project.status || 'Rảnh';
            const score = Number(state.project.score || 0);
            document.getElementById('project-score').textContent = score.toFixed(1);
            document.getElementById('iteration-count').textContent = state.project.current_iteration || 0;
            document.getElementById('decisions-count').textContent = state.pendingDecisions.length;
            const scoreEl = document.getElementById('project-score');
            if (!document.body.classList.contains('performance-mode')) {
                scoreEl.classList.remove('animated');
                scoreEl.offsetHeight;
                scoreEl.classList.add('animated');
            }
            updateScoreSparkline(score);
            updateControlDockBadges();
        }

        function updateDecisions() {
            const container = document.getElementById('decisions-list');
            document.getElementById('pending-count').textContent = state.pendingDecisions.length;
            updateControlDockBadges();

            if (state.pendingDecisions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">✅</div>
                        <div class="empty-state-text">Không có quyết định chờ duyệt</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = state.pendingDecisions.map(decision => `
                <div class="decision-item">
                    <div class="decision-header">
                        <span class="decision-action">${escapeHtml(decision.title || decision.action || 'Chưa rõ')}</span>
                        <span class="decision-risk ${decision.risk_level || 'medium'}">${decision.risk_level || 'medium'}</span>
                    </div>
                    <div class="decision-details">
                        ${renderDecisionDetails(decision)}
                    </div>
                    <div class="decision-actions">
                        <button class="decision-btn approve" onclick="approveDecision('${decision.id}')">${decision.kind === 'command_intervention' ? '✓ Duyệt & chạy' : '✓ Duyệt'}</button>
                        <button class="decision-btn decline" onclick="declineDecision('${decision.id}')">✗ Từ chối</button>
                    </div>
                </div>
            `).join('');
        }

        function renderDecisionDetails(decision) {
            if (!decision || typeof decision !== 'object') return '';
            const details = decision.details || {};
            if (decision.kind === 'command_intervention') {
                const instance = String(decision.instance_name || decision.instance_id || 'orion');
                const command = String(decision.command || details.command || '').trim();
                const rec = String(details.guardian_decision || '').trim();
                const reason = String(details.reason || '').trim();
                const safer = String(details.safer_alternative || '').trim();
                const lines = [
                    `Instance: ${instance}`,
                    command ? `Command: ${command}` : '',
                    rec ? `Guardian: ${rec}` : '',
                    reason ? `Lý do: ${reason}` : '',
                    safer ? `An toàn hơn: ${safer}` : '',
                ].filter(Boolean);
                return escapeHtml(lines.join(' • '));
            }
            return decision.details ? escapeHtml(JSON.stringify(decision.details).substring(0, 220)) : '';
        }

        async function loadAgentsStatus() {
            try {
                const response = await fetch('/api/agents/status');
                const data = await response.json();
                state.agentFleet = data.agents || [];
                state.orionInstances = data.instances || state.orionInstances;
                state.runtime = data.runtime || state.runtime;
                if (state.runtime?.agent_controls && typeof state.runtime.agent_controls === 'object') {
                    state.agentControls = state.runtime.agent_controls;
                }
                syncProviderProfileFromRuntime(state.runtime?.provider_profile);
                scheduleFleetRender();
                scheduleFlowRender();
                renderInstanceStrip();
                if (state.runtime) {
                    updateRuntimeBadges(state.runtime);
                }
                renderProviderHub();
                if (!state.agentActivity) {
                    loadAgentActivity();
                }
            } catch (error) {
                console.error('Failed to load agents status:', error);
            }
        }

        async function loadOrionInstances() {
            try {
                const response = await fetch('/api/orion/instances');
                const data = await response.json();
                state.orionInstances = data.instances || [];
                if (!state.selectedInstanceId) {
                    state.selectedInstanceId = data.default_instance_id || 'orion-1';
                }
                if (!state.orionInstances.some((item) => String(item.id) === String(state.selectedInstanceId))) {
                    state.selectedInstanceId = state.orionInstances[0]?.id || (data.default_instance_id || 'orion-1');
                }
                syncInstanceSelect();
                renderInstanceStrip();
                loadAgentActivity();
            } catch (error) {
                console.error('Failed to load Orion instances:', error);
            }
        }

        async function loadAgentActivity() {
            const instanceId = getSelectedInstance();
            try {
                const response = await fetch(`/api/agents/activity?instance_id=${encodeURIComponent(instanceId)}&limit=18`);
                const data = await response.json();
                if (data?.activity) {
                    state.agentActivity = data.activity;
                    if (data.activity.agent_controls && typeof data.activity.agent_controls === 'object') {
                        state.agentControls = data.activity.agent_controls;
                    }
                    maybeNarrateAgentActivity(data.activity);
                    scheduleFleetRender();
                    scheduleFlowRender();
                }
            } catch (error) {
                console.error('Failed to load agents activity:', error);
            }
        }

        async function loadMonitorAutopilot() {
            try {
                const response = await fetch('/api/monitor/autopilot');
                const data = await response.json();
                if (data?.supervisor) {
                    state.monitorSupervisor = data.supervisor;
                    renderMonitorAutopilot();
                }
            } catch (error) {
                console.error('Failed to load monitor autopilot:', error);
            }
        }

        function renderMonitorAutopilot() {
            const chip = document.getElementById('monitor-autopilot-chip');
            const btn = document.getElementById('monitor-autopilot-btn');
            const enabled = !!state?.monitorSupervisor?.enabled;
            if (chip) chip.textContent = `Autopilot: ${enabled ? 'ON' : 'OFF'}`;
            if (btn) btn.textContent = enabled ? 'Tắt Autopilot' : 'Bật Autopilot';
            updateControlDockBadges();
        }

        async function toggleMonitorAutopilot() {
            const enabled = !!state?.monitorSupervisor?.enabled;
            try {
                const response = await fetch('/api/monitor/autopilot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: !enabled }),
                });
                const data = await response.json();
                if (data?.success) {
                    state.monitorSupervisor = data.supervisor || state.monitorSupervisor;
                    renderMonitorAutopilot();
                    showToast('success', `Monitor autopilot ${state.monitorSupervisor?.enabled ? 'ON' : 'OFF'}`);
                } else {
                    showToast('warning', data?.error || 'Không đổi được monitor autopilot');
                }
            } catch (error) {
                console.error('Failed to toggle monitor autopilot:', error);
                showToast('error', 'Không thể đổi monitor autopilot');
            }
        }

        async function loadComputerControlStatus() {
            try {
                const response = await fetch('/api/computer-control/status');
                const data = await response.json();
                if (data?.control) {
                    state.computerControl = data.control;
                    renderComputerControlStatus();
                }
            } catch (error) {
                console.error('Failed to load computer-control status:', error);
            }
        }

        function renderComputerControlStatus() {
            const control = state.computerControl || {};
            openclawStatus.controlOn = !!control.available && !!control.enabled;
            renderOpenClawStatus(openclawStatus.dashboard, openclawStatus.metrics);
            updateControlDockBadges();
        }

        function summarizeCostGuardProfile(costGuard) {
            const profile = costGuard?.profile || {};
            const nova = profile?.nova_stable_interval ?? '-';
            const echo = profile?.echo_interval ?? '-';
            const security = profile?.security_audit_interval ?? '-';
            return `Nova cadence ${nova} · Echo ${echo} · Security ${security}`;
        }

        function renderCostGuard() {
            const mode = String(state?.costGuard?.mode || 'balanced').toUpperCase();
            const chip = document.getElementById('cost-guard-chip');
            const badge = document.getElementById('control-cost-label');
            const desc = document.getElementById('cost-guard-desc');
            if (chip) chip.textContent = `Cost Guard: ${mode}`;
            if (badge) badge.textContent = `Cost: ${mode}`;
            if (desc) desc.textContent = summarizeCostGuardProfile(state.costGuard);
        }

        async function loadCostGuard() {
            const instanceId = getSelectedInstance();
            try {
                const response = await fetch(`/api/cost-guard?instance_id=${encodeURIComponent(instanceId)}`);
                const data = await response.json();
                if (data?.cost_guard && typeof data.cost_guard === 'object') {
                    state.costGuard = data.cost_guard;
                    renderCostGuard();
                }
            } catch (error) {
                console.error('Failed to load cost guard:', error);
            }
        }

        async function setCostGuardMode(mode) {
            const instanceId = getSelectedInstance();
            try {
                const response = await fetch('/api/cost-guard', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instance_id: instanceId, mode }),
                });
                const data = await response.json();
                if (data?.success) {
                    if (data.cost_guard && typeof data.cost_guard === 'object') {
                        state.costGuard = data.cost_guard;
                    }
                    renderCostGuard();
                    pushCommandMessage('system', `Cost guard -> ${String(mode).toUpperCase()} (${instanceId.toUpperCase()})`, 'system');
                    showToast('success', `Cost guard ${String(mode).toUpperCase()}`);
                } else {
                    showToast('warning', data?.error || 'Không đổi được cost guard mode');
                }
            } catch (error) {
                console.error('Failed to set cost guard mode:', error);
                showToast('error', 'Không thể đổi cost guard mode');
            }
        }

        function providerInputId(providerId, field) {
            const safeProvider = String(providerId || '')
                .trim()
                .toLowerCase()
                .replace(/[^a-z0-9_-]/g, '-');
            const safeField = String(field || '')
                .trim()
                .toLowerCase()
                .replace(/[^a-z0-9_-]/g, '-');
            return `provider-${safeProvider}-${safeField}`;
        }

        function bindingInputId(agentName, field) {
            const safeAgent = String(agentName || '')
                .trim()
                .toLowerCase()
                .replace(/[^a-z0-9_-]/g, '-');
            const safeField = String(field || '')
                .trim()
                .toLowerCase()
                .replace(/[^a-z0-9_-]/g, '-');
            return `binding-${safeAgent}-${safeField}`;
        }

        function providerCatalogSnapshot() {
            const fallback = {
                providers: [
                    { id: 'glm', label: 'GLM (z.ai)', kind: 'api' },
                    { id: 'google', label: 'Google Gemini', kind: 'api' },
                    { id: 'anthropic', label: 'Anthropic-compatible', kind: 'api' },
                    { id: 'openai_compatible', label: 'OpenAI-compatible', kind: 'api' },
                    { id: 'codex_cli', label: 'Codex CLI subscription', kind: 'subscription' },
                    { id: 'claude_cli', label: 'Claude Code CLI subscription', kind: 'subscription' },
                    { id: 'gemini_cli', label: 'Gemini CLI subscription', kind: 'subscription' },
                ],
                agents: ['orion', 'guardian', 'nova', 'pixel', 'cipher', 'flux', 'echo'],
            };
            const catalog = state.providerCatalog;
            if (!catalog || typeof catalog !== 'object') return fallback;
            const providers = Array.isArray(catalog.providers) && catalog.providers.length
                ? catalog.providers
                : fallback.providers;
            const agents = Array.isArray(catalog.agents) && catalog.agents.length
                ? catalog.agents
                : fallback.agents;
            return { providers, agents };
        }

        function providerProfileSnapshot() {
            const profile = state.providerProfile;
            if (profile && typeof profile === 'object') return profile;
            return {
                providers: {},
                agent_bindings: {},
                routing: {
                    smart_routing_enabled: true,
                    auto_subscription_cost_routing: true,
                    keep_current_model_first: false,
                },
                updated_at: null,
            };
        }

        function providerFieldDefinitions(providerId) {
            const id = String(providerId || '').trim().toLowerCase();
            if (id === 'codex_cli') {
                return [
                    { key: 'cli_cmd', label: 'CLI cmd', placeholder: 'codex' },
                    { key: 'cli_args', label: 'CLI args', placeholder: '-p' },
                    { key: 'model_high', label: 'Model high', placeholder: 'codex-5.3-x2' },
                    { key: 'model_low', label: 'Model low', placeholder: 'codex-5.3-mini' },
                ];
            }
            if (id === 'claude_cli') {
                return [
                    { key: 'cli_cmd', label: 'CLI cmd', placeholder: 'claude' },
                    { key: 'cli_args', label: 'CLI args', placeholder: '-p' },
                    { key: 'model', label: 'Model', placeholder: 'claude-code' },
                ];
            }
            if (id === 'gemini_cli') {
                return [
                    { key: 'cli_cmd', label: 'CLI cmd', placeholder: 'gemini' },
                    { key: 'cli_args', label: 'CLI args', placeholder: '-m {model} -p' },
                    { key: 'model_flash', label: 'Flash model', placeholder: 'gemini-3.0-flash' },
                    { key: 'model_pro', label: 'Pro model', placeholder: 'gemini-3.0-pro' },
                ];
            }
            return [
                { key: 'api_base', label: 'API base', placeholder: 'https://api.example.com/v1' },
                { key: 'default_model', label: 'Default model', placeholder: 'model-default' },
            ];
        }

        function isApiProvider(providerId) {
            const id = String(providerId || '').trim().toLowerCase();
            return !['codex_cli', 'claude_cli', 'gemini_cli'].includes(id);
        }

        function readInputValue(id, fallback = '') {
            const element = document.getElementById(String(id || ''));
            if (!element || typeof element.value !== 'string') return String(fallback || '');
            return String(element.value || '');
        }

        function readInputChecked(id, fallback = false) {
            const element = document.getElementById(String(id || ''));
            if (!element || typeof element.checked !== 'boolean') return !!fallback;
            return !!element.checked;
        }

        function markProviderDirty() {
            if (!state.providerDirty) {
                state.providerDirty = true;
            }
            const meta = document.getElementById('provider-meta');
            if (meta) meta.textContent = 'Chưa apply (có thay đổi mới)';
        }

        function syncProviderProfileFromRuntime(runtimeProfile) {
            if (!runtimeProfile || typeof runtimeProfile !== 'object') return;
            if (state.providerDirty) return;
            state.providerProfile = runtimeProfile;
        }

        async function loadProviderCatalog() {
            try {
                const response = await fetch('/api/providers/catalog');
                const data = await response.json();
                if (data?.success && data.catalog && typeof data.catalog === 'object') {
                    state.providerCatalog = data.catalog;
                    renderProviderHub();
                }
            } catch (error) {
                console.error('Failed to load provider catalog:', error);
            }
        }

        async function loadProviderProfile(force = false) {
            if (state.providerDirty && !force) return;
            const instanceId = getSelectedInstance();
            try {
                const response = await fetch(`/api/providers/profile?instance_id=${encodeURIComponent(instanceId)}`);
                const data = await response.json();
                if (data?.success && data.profile && typeof data.profile === 'object') {
                    state.providerProfile = data.profile;
                    if (data.catalog && typeof data.catalog === 'object') {
                        state.providerCatalog = data.catalog;
                    }
                    state.providerDirty = false;
                    renderProviderHub(true);
                }
            } catch (error) {
                console.error('Failed to load provider profile:', error);
            }
        }

        function renderProviderHub(force = false) {
            const card = document.getElementById('provider-card');
            if (!card) return;
            if (state.providerDirty && !force && card.dataset.providerRendered === '1') {
                const meta = document.getElementById('provider-meta');
                if (meta) meta.textContent = 'Chưa apply (có thay đổi mới)';
                return;
            }

            const catalog = providerCatalogSnapshot();
            const profile = providerProfileSnapshot();
            const providers = Array.isArray(catalog.providers) ? catalog.providers : [];
            const agents = Array.isArray(catalog.agents) ? catalog.agents : [];
            const providerConfigs = (profile.providers && typeof profile.providers === 'object') ? profile.providers : {};
            const bindings = (profile.agent_bindings && typeof profile.agent_bindings === 'object')
                ? profile.agent_bindings
                : {};
            const routing = (profile.routing && typeof profile.routing === 'object') ? profile.routing : {};
            const updatedAt = profile.updated_at ? new Date(profile.updated_at).toLocaleString() : 'Chưa đồng bộ';

            const providerGrid = providers.map((item) => {
                const id = String(item?.id || '').trim().toLowerCase();
                if (!id) return '';
                const kind = String(item?.kind || '').trim().toLowerCase() || 'api';
                const label = String(item?.label || id);
                const cfg = (providerConfigs[id] && typeof providerConfigs[id] === 'object') ? providerConfigs[id] : {};
                const enabled = !!cfg.enabled;
                const hasKey = !!cfg.has_api_key || !!cfg.api_key;
                const masked = String(cfg.api_key || '').trim();
                const enabledId = providerInputId(id, 'enabled');
                const keyId = providerInputId(id, 'api_key');
                const clearKeyId = providerInputId(id, 'clear_key');

                const baseFields = providerFieldDefinitions(id).map((field) => {
                    const fieldId = providerInputId(id, field.key);
                    const value = String(cfg[field.key] ?? '');
                    return `
                        <div class="provider-field">
                            <label for="${fieldId}">${escapeHtml(field.label)}</label>
                            <input id="${fieldId}" type="text" value="${escapeHtml(value)}" placeholder="${escapeHtml(field.placeholder || '')}">
                        </div>
                    `;
                }).join('');

                const keySection = isApiProvider(id)
                    ? `
                        <div class="provider-field">
                            <label for="${keyId}">API key</label>
                            <input id="${keyId}" type="password" value="" placeholder="Nhập key mới hoặc để trống để giữ key cũ">
                        </div>
                        <label class="provider-toggle">
                            <input type="checkbox" id="${clearKeyId}">
                            Xóa API key đang lưu
                        </label>
                        <div class="provider-key-hint">Key hiện tại: ${hasKey ? 'Đã cấu hình' : 'Chưa có'}${masked ? ` (${escapeHtml(masked)})` : ''}</div>
                    `
                    : '';

                return `
                    <div class="provider-box ${kind === 'subscription' ? 'subscription' : 'api'}">
                        <div class="provider-box-head">
                            <div class="provider-box-title">${escapeHtml(label)}</div>
                            <span class="provider-box-kind">${escapeHtml(kind)}</span>
                        </div>
                        <label class="provider-toggle">
                            <input type="checkbox" id="${enabledId}" ${enabled ? 'checked' : ''}>
                            Kích hoạt provider
                        </label>
                        ${keySection}
                        ${baseFields}
                    </div>
                `;
            }).join('');

            const bindingRows = agents.map((agent) => {
                const name = String(agent || '').trim().toLowerCase();
                if (!name) return '';
                const cfg = (bindings[name] && typeof bindings[name] === 'object') ? bindings[name] : {};
                const selectedProvider = String(cfg.provider || 'glm').trim().toLowerCase() || 'glm';
                const providerSelectId = bindingInputId(name, 'provider');
                const modelInputId = bindingInputId(name, 'model');
                const smartId = bindingInputId(name, 'smart_routing');
                const smartRouting = cfg.smart_routing !== false;
                let providerOptions = providers.map((row) => {
                    const providerId = String(row?.id || '').trim().toLowerCase();
                    if (!providerId) return '';
                    const selected = providerId === selectedProvider ? 'selected' : '';
                    const text = String(row?.label || providerId);
                    return `<option value="${escapeHtml(providerId)}" ${selected}>${escapeHtml(text)}</option>`;
                }).join('');
                if (selectedProvider && !providers.some((row) => String(row?.id || '').trim().toLowerCase() === selectedProvider)) {
                    providerOptions += `<option value="${escapeHtml(selectedProvider)}" selected>${escapeHtml(`custom:${selectedProvider}`)}</option>`;
                }
                const modelValue = String(cfg.model || '');
                return `
                    <div class="provider-binding-row">
                        <div class="provider-binding-agent">${escapeHtml(name)}</div>
                        <div class="provider-field">
                            <label for="${providerSelectId}">Provider</label>
                            <select id="${providerSelectId}">${providerOptions}</select>
                        </div>
                        <div class="provider-field">
                            <label for="${modelInputId}">Model</label>
                            <input id="${modelInputId}" type="text" value="${escapeHtml(modelValue)}" placeholder="Tùy chọn theo agent">
                        </div>
                        <label class="provider-toggle">
                            <input id="${smartId}" type="checkbox" ${smartRouting ? 'checked' : ''}>
                            Smart routing
                        </label>
                    </div>
                `;
            }).join('');

            const smartRoutingEnabled = routing.smart_routing_enabled !== false;
            const autoSubRouting = routing.auto_subscription_cost_routing !== false;
            const keepCurrentFirst = routing.keep_current_model_first === true;

            card.innerHTML = `
                <div class="provider-head">
                    <div>
                        <div class="provider-title">🔌 Provider Hub (BYOK)</div>
                        <div class="provider-sub">Quản lý Codex, Claude Code, GLM và các provider khác. Áp dụng realtime theo từng agent, không cần terminal.</div>
                    </div>
                    <div class="provider-meta" id="provider-meta">${state.providerDirty ? 'Chưa apply (có thay đổi mới)' : `Đồng bộ: ${escapeHtml(updatedAt)}`}</div>
                </div>
                <div class="provider-actions">
                    <div class="provider-actions-left">
                        <button class="agreement-btn ghost" onclick="loadProviderProfile(true)">Tải lại profile</button>
                        <button class="agreement-btn ghost" onclick="loadProviderCatalog()">Refresh catalog</button>
                    </div>
                    <button class="agreement-btn" onclick="saveProviderProfile()">Apply Provider Profile</button>
                </div>
                <div class="provider-routing">
                    <label class="provider-toggle">
                        <input id="provider-routing-smart" type="checkbox" ${smartRoutingEnabled ? 'checked' : ''}>
                        Smart routing toàn hệ thống
                    </label>
                    <label class="provider-toggle">
                        <input id="provider-routing-auto-sub" type="checkbox" ${autoSubRouting ? 'checked' : ''}>
                        Auto subscription cost routing
                    </label>
                    <label class="provider-toggle">
                        <input id="provider-routing-keep-current" type="checkbox" ${keepCurrentFirst ? 'checked' : ''}>
                        Ưu tiên model hiện tại
                    </label>
                </div>
                <div class="provider-grid">${providerGrid || '<div class="provider-loading">Chưa có provider khả dụng.</div>'}</div>
                <div class="provider-bindings">
                    <div class="provider-bindings-title">Agent Bindings</div>
                    ${bindingRows || '<div class="provider-loading">Chưa có agent để map provider.</div>'}
                </div>
            `;
            card.dataset.providerRendered = '1';

            const trackedInputs = card.querySelectorAll('input, select');
            trackedInputs.forEach((node) => {
                node.addEventListener('input', markProviderDirty);
                node.addEventListener('change', markProviderDirty);
            });
        }

        function collectProviderProfilePatch() {
            const catalog = providerCatalogSnapshot();
            const providers = Array.isArray(catalog.providers) ? catalog.providers : [];
            const agents = Array.isArray(catalog.agents) ? catalog.agents : [];

            const patch = {
                providers: {},
                agent_bindings: {},
                routing: {
                    smart_routing_enabled: readInputChecked('provider-routing-smart', true),
                    auto_subscription_cost_routing: readInputChecked('provider-routing-auto-sub', true),
                    keep_current_model_first: readInputChecked('provider-routing-keep-current', false),
                },
            };

            providers.forEach((row) => {
                const providerId = String(row?.id || '').trim().toLowerCase();
                if (!providerId) return;
                const providerPatch = {
                    enabled: readInputChecked(providerInputId(providerId, 'enabled'), false),
                };

                providerFieldDefinitions(providerId).forEach((field) => {
                    const value = readInputValue(providerInputId(providerId, field.key), '');
                    providerPatch[field.key] = String(value || '').trim();
                });

                if (isApiProvider(providerId)) {
                    const nextKey = readInputValue(providerInputId(providerId, 'api_key'), '').trim();
                    const clearKey = readInputChecked(providerInputId(providerId, 'clear_key'), false);
                    if (clearKey) {
                        providerPatch.api_key = '';
                    } else if (nextKey) {
                        providerPatch.api_key = nextKey;
                    }
                }

                patch.providers[providerId] = providerPatch;
            });

            agents.forEach((agent) => {
                const agentName = String(agent || '').trim().toLowerCase();
                if (!agentName) return;
                patch.agent_bindings[agentName] = {
                    provider: readInputValue(bindingInputId(agentName, 'provider'), 'glm').trim().toLowerCase() || 'glm',
                    model: readInputValue(bindingInputId(agentName, 'model'), '').trim(),
                    smart_routing: readInputChecked(bindingInputId(agentName, 'smart_routing'), true),
                };
            });

            return patch;
        }

        async function saveProviderProfile() {
            const instanceId = getSelectedInstance();
            const profilePatch = collectProviderProfilePatch();
            try {
                const response = await fetch('/api/providers/profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        instance_id: instanceId,
                        profile: profilePatch,
                    }),
                });
                const data = await response.json();
                if (response.ok && data?.success) {
                    if (data.catalog && typeof data.catalog === 'object') {
                        state.providerCatalog = data.catalog;
                    }
                    if (data.profile && typeof data.profile === 'object') {
                        state.providerProfile = data.profile;
                    }
                    state.providerDirty = false;
                    renderProviderHub(true);
                    const appliedCount = Object.keys(data?.result?.applied?.applied_agents || {}).length;
                    showToast('success', `Đã apply Provider Profile (${appliedCount} agent)`);
                    loadAgentsStatus();
                    loadModelRoutingStatus();
                } else {
                    showToast('warning', data?.error || 'Apply provider profile thất bại');
                }
            } catch (error) {
                console.error('Failed to save provider profile:', error);
                showToast('error', 'Không apply được provider profile');
            }
        }

        async function sendComputerAction(action) {
            try {
                const response = await fetch('/api/computer-control/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action }),
                });
                const data = await response.json();
                const success = !!data?.success;
                const note = data?.result?.note || data?.result?.error || action;
                pushCommandMessage('system', `Computer control: ${note}`, success ? 'system' : 'error');
                showToast(success ? 'success' : 'warning', success ? `Đã chạy ${action}` : `Không chạy được ${action}`);
                loadComputerControlStatus();
            } catch (error) {
                console.error('Failed computer control action:', error);
                showToast('error', 'Computer control thất bại');
            }
        }

        async function pullProgressSnapshot() {
            try {
                const response = await fetch('/api/progress/snapshot');
                const data = await response.json();
                if (data?.success) {
                    showToast('success', 'Đã cập nhật snapshot');
                } else {
                    showToast('warning', data?.error || 'Không lấy được snapshot');
                }
            } catch (error) {
                console.error('Failed snapshot:', error);
                showToast('error', 'Snapshot thất bại');
            }
        }

        function getSelectedInstance() {
            return String(state.selectedInstanceId || 'orion-1');
        }

        function changeInstance(instanceId) {
            state.selectedInstanceId = String(instanceId || 'orion-1');
            syncInstanceSelect();
            loadAgentActivity();
            loadCostGuard();
            loadProviderProfile(true);
            showToast('info', `Đang điều khiển ${state.selectedInstanceId.toUpperCase()}`);
        }

        function syncInstanceSelect() {
            const select = document.getElementById('instance-select');
            if (!select) return;
            const instances = Array.isArray(state.orionInstances) ? state.orionInstances : [];
            if (!instances.length) {
                select.innerHTML = '<option value="orion-1">Orion 1</option>';
                select.value = 'orion-1';
                updateControlDockBadges();
                return;
            }
            select.innerHTML = instances.map((item) => {
                const id = escapeHtml(String(item.id || 'orion-1'));
                const name = escapeHtml(String(item.name || item.id || 'Orion'));
                return `<option value="${id}">${name}</option>`;
            }).join('');
            if (Array.from(select.options).some((opt) => opt.value === state.selectedInstanceId)) {
                select.value = state.selectedInstanceId;
            }
            updateControlDockBadges();
        }

        function updateControlDockBadges() {
            const instanceId = getSelectedInstance();
            const instance = (state.orionInstances || []).find(
                (item) => String(item.id || '') === instanceId
            );
            const name = String(instance?.name || instanceId).toUpperCase();
            const instanceLabel = document.getElementById('control-instance-label');
            if (instanceLabel) instanceLabel.textContent = `Instance: ${name}`;

            const autopilot = !!state?.monitorSupervisor?.enabled;
            const autopilotLabel = document.getElementById('control-autopilot-label');
            if (autopilotLabel) autopilotLabel.textContent = `Autopilot: ${autopilot ? 'ON' : 'OFF'}`;

            const control = state.computerControl || {};
            const computerOn = !!control.available && !!control.enabled;
            const computerLabel = document.getElementById('control-computer-label');
            if (computerLabel) computerLabel.textContent = `Computer: ${computerOn ? 'ON' : 'OFF'}`;

            const pendingLabel = document.getElementById('control-pending-label');
            if (pendingLabel) pendingLabel.textContent = `Pending: ${state.pendingDecisions.length}`;
            renderCostGuard();
        }

        function renderInstanceStrip() {
            const container = document.getElementById('instance-strip');
            if (!container) return;
            const instances = Array.isArray(state.orionInstances) ? state.orionInstances : [];
            if (!instances.length) {
                container.innerHTML = '<div class="empty-state-text">Chưa có Orion instance.</div>';
                return;
            }
            container.innerHTML = instances.map((item) => {
                const id = String(item.id || 'orion-1');
                const name = escapeHtml(String(item.name || id));
                const running = !!item.running;
                const paused = !!item.paused;
                const mode = paused ? 'Tạm dừng' : (running ? 'Đang chạy' : 'Rảnh');
                const iteration = item.iteration != null ? `vòng ${item.iteration}` : 'vòng n/a';
                const activeFlows = Number(item.active_flow_count || 0);
                const agentCount = Number(item.agent_count || 0);
                const escaped = id.replace(/'/g, "\\'");
                return `
                    <div class="instance-item">
                        <div class="instance-top">
                            <div class="instance-name">${name} · ${escapeHtml(mode)}</div>
                            <div class="instance-meta">${escapeHtml(iteration)} · ${activeFlows} flows · ${agentCount} agents</div>
                        </div>
                        <div class="instance-actions">
                            <button class="instance-btn" onclick="changeInstance('${escaped}')">Chọn điều khiển</button>
                            <button class="instance-btn" onclick="sendInstanceGuardian('${escaped}','unstick_orion')">Guardian gỡ kẹt</button>
                            <button class="instance-btn" onclick="sendInstanceGuardian('${escaped}','autopilot_on')">Autopilot ON</button>
                            <button class="instance-btn" onclick="sendInstanceGuardian('${escaped}','autopilot_off')">Autopilot OFF</button>
                        </div>
                    </div>
                `;
            }).join('');
            syncInstanceSelect();
        }

        async function sendInstanceGuardian(instanceId, command) {
            try {
                const response = await fetch('/api/orion/instances/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        instance_id: instanceId,
                        target: 'guardian',
                        command,
                        priority: 'high',
                    }),
                });
                const data = await response.json();
                pushCommandMessage('system', summarizeCommandResponse(data), data.success ? 'system' : 'error');
                showToast(data.success ? 'success' : 'warning', `${instanceId.toUpperCase()} · ${command}`);
                loadOrionInstances();
                loadAgentActivity();
            } catch (error) {
                console.error('Failed instance guardian command:', error);
                showToast('error', 'Không gửi được lệnh Guardian theo instance');
            }
        }

        function addAgentLog(payload) {
            const agent = payload?.agent || payload?.entry?.agent;
            const entry = payload?.entry;
            if (!agent || !entry) return;

            if (!state.agentLogs[agent]) state.agentLogs[agent] = [];
            state.agentLogs[agent].push(entry);
            if (state.agentLogs[agent].length > 100) {
                state.agentLogs[agent] = state.agentLogs[agent].slice(-100);
            }

            let found = false;
            state.agentFleet = state.agentFleet.map((item) => {
                if (item.name !== agent) return item;
                found = true;
                return {
                    ...item,
                    online: true,
                    last_seen: entry.timestamp,
                    last_message: entry.message,
                    last_level: entry.level || 'info',
                    logs_count: Number(item.logs_count || 0) + 1,
                };
            });
            if (!found) {
                state.agentFleet.push({
                    name: agent,
                    online: true,
                    last_seen: entry.timestamp,
                    last_message: entry.message,
                    last_level: entry.level || 'info',
                    logs_count: 1,
                });
            }

            streamAgentLogToCommandConsole(agent, entry);
            scheduleFleetRender();
            scheduleFlowRender();
            scheduleInsightRender();
        }

        function updateAgentTargets(agentNames) {
            const select = document.getElementById('fleet-target');
            if (!select) return;
            const current = select.value || 'all';

            const normalized = Array.from(new Set((agentNames || []).map((name) => String(name).toLowerCase())))
                .filter((name) => name && name !== 'all' && name !== 'orion');
            const dynamicOptions = normalized.map((name) => `<option value="${escapeHtml(name)}">${escapeHtml(name.toUpperCase())}</option>`).join('');
            select.innerHTML = `
                <option value="all">TẤT CẢ AGENT</option>
                <option value="orion">ORION / HỆ THỐNG</option>
                ${dynamicOptions}
            `;

                if (Array.from(select.options).some((opt) => opt.value === current)) {
                    select.value = current;
                }

            const opsFilter = document.getElementById('ops-filter-agent');
            if (opsFilter) {
                const currentOps = opsFilter.value || 'all';
                opsFilter.innerHTML = `
                    <option value="all">Tất cả agent</option>
                    ${dynamicOptions}
                `;
                if (Array.from(opsFilter.options).some((opt) => opt.value === currentOps)) {
                    opsFilter.value = currentOps;
                }
            }
        }

        function getRealtimeAgentMeta(agentName) {
            const target = String(agentName || '').toLowerCase();
            if (!target) return {};
            const activityRows = Array.isArray(state?.agentActivity?.agents) ? state.agentActivity.agents : [];
            const fromActivity = activityRows.find((row) => String(row?.name || '').toLowerCase() === target);
            if (fromActivity) return fromActivity;
            const runtimeRows = Array.isArray(state?.runtime?.agent_runtime) ? state.runtime.agent_runtime : [];
            const fromRuntime = runtimeRows.find((row) => String(row?.name || '').toLowerCase() === target);
            return fromRuntime || {};
        }

        function getAgentControlState(agentName) {
            const target = String(agentName || '').toLowerCase();
            if (!target) return { enabled: true };
            const runtimeControls = (state.runtime && typeof state.runtime.agent_controls === 'object')
                ? state.runtime.agent_controls
                : {};
            const activityControls = (state.agentActivity && typeof state.agentActivity.agent_controls === 'object')
                ? state.agentActivity.agent_controls
                : {};
            const snapshot = state.agentControls && typeof state.agentControls === 'object'
                ? state.agentControls
                : {};
            const control = runtimeControls[target] || activityControls[target] || snapshot[target] || {};
            return {
                enabled: control.enabled !== false,
                reason: String(control.reason || ''),
                updated_at: control.updated_at || null,
                updated_by: String(control.updated_by || ''),
            };
        }

        function updateFleetUI() {
            const fleet = Array.isArray(state.agentFleet) ? [...state.agentFleet] : [];
            fleet.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

            updateAgentTargets(fleet.map((item) => item.name));

            const onlineCount = fleet.filter((item) => {
                const realtimeMeta = getRealtimeAgentMeta(item?.name);
                return buildFleetStatus(item, realtimeMeta).className === 'online';
            }).length;
            const countEl = document.getElementById('fleet-count');
            if (countEl) countEl.textContent = `${onlineCount}/${fleet.length || 0} đang online`;

            const container = document.getElementById('fleet-grid');
            if (!container) return;
            if (!fleet.length) {
                container.innerHTML = '<div class="empty-state-text">Đang chờ agent hoạt động...</div>';
                renderBatchTargetChecks([]);
                return;
            }

            container.innerHTML = fleet.map((item) => {
                const rawName = String(item.name || 'unknown').toLowerCase();
                const realtimeMeta = getRealtimeAgentMeta(rawName);
                const control = getAgentControlState(rawName);
                const name = escapeHtml(rawName.toUpperCase());
                const status = buildFleetStatus(item, realtimeMeta);
                const task = String(realtimeMeta?.task || realtimeMeta?.current_task || '').trim();
                const role = String(realtimeMeta?.role || AGENT_ROLE_LABELS[rawName] || 'Agent chuyên trách').trim();
                const baseLast = task
                    ? `Task realtime: ${task}`
                    : humanizeLogMessage(item.last_message || 'Chưa có hoạt động gần đây');
                const controlSuffix = rawName !== 'orion'
                    ? (control.enabled
                        ? 'Autopilot ON'
                        : `Autopilot OFF${control.reason ? ` (${control.reason})` : ''}`)
                    : '';
                const last = controlSuffix ? `${baseLast} · ${controlSuffix}` : baseLast;
                const seen = item.last_seen ? formatRelativeTime(item.last_seen) : 'Chưa có';
                const logs = Number(item.logs_count || 0);
                const escapedTarget = rawName.replace(/'/g, "\\'");
                const safeInputId = `fleet-inline-${rawName.replace(/[^a-z0-9_-]/g, '-')}`;
                const actionButtons = rawName === 'orion'
                    ? `
                        <button class="fleet-act-btn" onclick="quickAgentAction('${escapedTarget}', 'status')">Trạng thái</button>
                        <button class="fleet-act-btn" onclick="quickAgentAction('${escapedTarget}', 'pause')">Tạm dừng</button>
                        <button class="fleet-act-btn" onclick="quickAgentAction('${escapedTarget}', 'resume')">Tiếp tục</button>
                        <button class="fleet-act-btn" onclick="quickAgentAction('${escapedTarget}', 'run_cycle')">Chạy vòng</button>
                        `
                        : (rawName === 'guardian'
                        ? `
                            <button class="fleet-act-btn" onclick="quickAgentAction('${escapedTarget}', 'status')">Trạng thái</button>
                            <button class="fleet-act-btn" onclick="quickAgentAction('${escapedTarget}', 'unstick_orion')">Gỡ kẹt</button>
                            <button class="fleet-act-btn" onclick="quickAgentAction('${escapedTarget}', 'autopilot_on')">Auto ON</button>
                            <button class="fleet-act-btn" onclick="quickAgentAction('${escapedTarget}', 'autopilot_off')">Auto OFF</button>
                        `
                        : `
                            <button class="fleet-act-btn" onclick="quickAgentAction('${escapedTarget}', 'status')">Trạng thái</button>
                            <button class="fleet-act-btn" onclick="toggleAgentAutopilot('${escapedTarget}', ${control.enabled ? 'false' : 'true'})">
                                ${control.enabled ? 'Auto OFF' : 'Auto ON'}
                            </button>
                            <button class="fleet-act-btn" onclick="quickAgentAction('${escapedTarget}', 'run_cycle')">Chạy</button>
                        `);
                return `
                    <div class="fleet-item">
                        <div class="fleet-item-head">
                            <div class="fleet-name">${name}</div>
                            <div class="fleet-status ${status.className}">${status.label}</div>
                        </div>
                        <div class="fleet-last">${escapeHtml(last)}</div>
                        <div class="fleet-role">${escapeHtml(role)}</div>
                        <div class="fleet-meta">
                            <span>${seen}</span>
                            <span>${formatCompactNumber(logs)} log</span>
                        </div>
                        <div class="fleet-actions">
                            ${actionButtons}
                        </div>
                        <div class="fleet-inline-command">
                            <input id="${safeInputId}" type="text" placeholder="Lệnh trực tiếp cho ${rawName.toUpperCase()}"
                                   onkeypress="if(event.key==='Enter')sendInlineAgentCommand('${escapedTarget}','${safeInputId}')">
                            <button onclick="sendInlineAgentCommand('${escapedTarget}','${safeInputId}')">Gửi</button>
                        </div>
                    </div>
                `;
            }).join('');
            renderBatchTargetChecks(fleet.map((item) => item.name));
        }

        function renderFlowOverview() {
            const flowList = document.getElementById('flow-list');
            const flowCountChip = document.getElementById('flow-count-chip');
            const agentOnlineChip = document.getElementById('agent-online-chip');
            const instanceCountChip = document.getElementById('instance-count-chip');
            const runtimeFlowChip = document.getElementById('runtime-flow-chip');
            if (!flowList) return;

            const runtime = state.runtime || {};
            const activity = state.agentActivity || {};
            const runtimeFlows = Array.isArray(activity.active_flows) && activity.active_flows.length
                ? activity.active_flows
                : (Array.isArray(runtime.active_flows) ? runtime.active_flows : []);
            const runtimeAgents = Array.isArray(activity.agents) && activity.agents.length
                ? activity.agents.map((item) => ({
                    name: item.name,
                    role: item.role,
                    running: item.running,
                    current_task: item.task,
                    enabled: item.enabled !== false,
                }))
                : (Array.isArray(runtime.agent_runtime) ? runtime.agent_runtime : []);
            const fleet = Array.isArray(state.agentFleet) ? state.agentFleet : [];
            const instances = Array.isArray(state.orionInstances) ? state.orionInstances : [];
            const selectedInstance = (state.orionInstances || []).find(
                (item) => String(item.id || '') === getSelectedInstance()
            ) || null;

            const onlineCount = fleet.filter((item) => !!item?.online).length;
            if (agentOnlineChip) {
                agentOnlineChip.textContent = `${onlineCount}/${fleet.length || 0} agent online`;
            }
            if (instanceCountChip) {
                const runningInstances = instances.filter((item) => !!item?.running && !item?.paused).length;
                instanceCountChip.textContent = `${runningInstances}/${instances.length || 0} instance chạy`;
            }
            if (runtimeFlowChip) {
                const runtimeActiveCount = runtimeFlows.filter((row) => !!row?.active).length;
                runtimeFlowChip.textContent = `${runtimeActiveCount}/${runtimeFlows.length || 0} runtime flow`;
            }
            renderComputerControlStatus();

            const flowRows = [];
            const useRuntimeFlows = !!runtimeFlows.length && (!selectedInstance || selectedInstance.id === 'orion-1');
            const sourceFlows = useRuntimeFlows
                ? runtimeFlows
                : (selectedInstance
                    ? [{
                        id: 'instance_runtime',
                        name: `${selectedInstance.name || selectedInstance.id} Runtime`,
                        active: !!selectedInstance.running && !selectedInstance.paused,
                        detail: selectedInstance.paused ? 'Instance đang tạm dừng' : 'Instance đang chạy',
                    }]
                    : []);
            for (const flow of sourceFlows) {
                flowRows.push({
                    key: `flow:${flow.id || flow.name || 'runtime'}`,
                    name: String(flow.name || 'Runtime flow'),
                    desc: String(flow.detail || ''),
                    active: !!flow.active,
                    status: flow.active ? 'ACTIVE' : 'IDLE',
                });
            }

            for (const item of fleet) {
                const name = String(item?.name || 'unknown').toLowerCase();
                const runtimeMeta = runtimeAgents.find((agent) => String(agent?.name || '').toLowerCase() === name) || {};
                const role = String(runtimeMeta.role || AGENT_ROLE_LABELS[name] || 'Agent chuyên trách');
                const activity = humanizeLogMessage(item?.last_message || 'Đang chờ tác vụ');
                const task = String(runtimeMeta.current_task || '').trim();
                const enabled = runtimeMeta.enabled !== false;
                const desc = task
                    ? `${role} • task: ${task}${enabled ? '' : ' • autopilot OFF'}`
                    : `${role} • ${activity}${enabled ? '' : ' • autopilot OFF'}`;
                flowRows.push({
                    key: `agent:${name}`,
                    name: name.toUpperCase(),
                    desc,
                    active: enabled && !!item?.online,
                    status: enabled ? (item?.online ? 'ONLINE' : 'IDLE') : 'AUTO OFF',
                });
            }

            const activeCount = flowRows.filter((row) => !!row.active).length;
            if (flowCountChip) {
                flowCountChip.textContent = `${activeCount}/${flowRows.length || 0} luồng active`;
            }

            if (!flowRows.length) {
                flowList.innerHTML = '<div class="empty-state-text">Chưa có luồng hoạt động để hiển thị.</div>';
                return;
            }

            flowList.innerHTML = flowRows.map((row) => `
                <div class="flow-item ${row.active ? 'active' : ''}">
                    <span class="flow-dot"></span>
                    <div class="flow-main">
                        <div class="flow-name">${escapeHtml(row.name)}</div>
                        <div class="flow-desc">${escapeHtml(row.desc)}</div>
                    </div>
                    <div class="flow-status">${escapeHtml(row.status)}</div>
                </div>
            `).join('');
        }

        function buildFleetStatus(item, realtimeMeta = null) {
            const name = String(item?.name || '').toLowerCase();
            const meta = realtimeMeta || {};
            const control = getAgentControlState(name);
            if (name === 'orion' && state.runtime) {
                if (state.runtime.paused) {
                    return { className: 'paused', label: 'Tạm dừng' };
                }
                if (state.runtime.running) {
                    return { className: 'online', label: 'Đang chạy' };
                }
            }
            if (name !== 'orion' && !control.enabled) {
                return { className: 'paused', label: 'Auto OFF' };
            }
            if (meta?.running) {
                return { className: 'online', label: 'Running' };
            }
            if (item?.online) {
                return { className: 'online', label: 'Online' };
            }
            return { className: '', label: 'Rảnh' };
        }

        function renderBatchTargetChecks(agentNames) {
            const container = document.getElementById('fleet-target-checks');
            if (!container) return;
            const valid = (agentNames || [])
                .map((name) => String(name).toLowerCase())
                .filter((name) => name && name !== 'all');
            if (!valid.length) {
                container.innerHTML = '<span class="empty-state-text">Chưa có agent khả dụng</span>';
                return;
            }

            container.innerHTML = valid.map((name) => `
                <label>
                    <input type="checkbox" value="${escapeHtml(name)}" checked>
                    <span>${escapeHtml(name.toUpperCase())}</span>
                </label>
            `).join('');
        }

        async function sendInlineAgentCommand(target, inputId) {
            const input = document.getElementById(String(inputId || ''));
            const command = (input?.value || '').trim();
            if (!command) {
                showToast('warning', `Nhập lệnh cho ${String(target || '').toUpperCase()}`);
                return;
            }
            if (input) input.value = '';
            await quickAgentAction(target, command);
        }

        async function quickAgentAction(target, command) {
            const normalizedTarget = String(target || '').toLowerCase();
            const normalizedCommand = String(command || '').trim();
            if (!normalizedTarget || !normalizedCommand) return;

            const instanceId = getSelectedInstance();
            pushCommandMessage('user', `${instanceId.toUpperCase()}::${normalizedTarget.toUpperCase()}: ${normalizedCommand}`);
            rememberCommandContext([normalizedTarget], normalizedCommand);
            const options = getControlOptions();

            try {
                const response = await fetch('/api/agent/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        instance_id: instanceId,
                        target: normalizedTarget,
                        command: normalizedCommand,
                        priority: 'high',
                        options,
                    }),
                });
                const data = await response.json();
                const tone = data.success ? 'system' : 'error';
                pushCommandMessage('system', summarizeCommandResponse(data), tone);
                showToast(data.success ? 'success' : 'warning', `${normalizedTarget.toUpperCase()} • ${normalizedCommand}`);
                loadAgentsStatus();
                loadAgentActivity();
            } catch (error) {
                console.error('Quick action failed:', error);
                pushCommandMessage('system', `Lệnh nhanh lỗi: ${error.message || error}`, 'error');
                showToast('error', 'Lệnh nhanh thất bại');
            }
        }

        async function toggleAgentAutopilot(target, enabled) {
            const normalizedTarget = String(target || '').toLowerCase();
            if (!normalizedTarget || normalizedTarget === 'orion' || normalizedTarget === 'all') return;
            const instanceId = getSelectedInstance();
            const modeLabel = enabled ? 'Auto ON' : 'Auto OFF';
            pushCommandMessage('user', `${instanceId.toUpperCase()}::${normalizedTarget.toUpperCase()}: ${modeLabel}`);
            rememberCommandContext([normalizedTarget], enabled ? 'resume' : 'pause');
            try {
                const response = await fetch('/api/agents/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        instance_id: instanceId,
                        target: normalizedTarget,
                        enabled: !!enabled,
                        reason: 'dashboard_quick_toggle',
                    }),
                });
                const data = await response.json();
                if (data.success) {
                    showToast('success', `${normalizedTarget.toUpperCase()} -> ${modeLabel}`);
                    pushCommandMessage('system', summarizeCommandResponse(data), 'system');
                } else {
                    showToast('warning', data.error || `${normalizedTarget.toUpperCase()} toggle thất bại`);
                    pushCommandMessage('system', summarizeCommandResponse(data), 'error');
                }
                await loadAgentsStatus();
                await loadAgentActivity();
            } catch (error) {
                console.error('Failed to toggle agent autopilot:', error);
                showToast('error', 'Không thể đổi trạng thái autopilot agent');
                pushCommandMessage('system', `Toggle autopilot lỗi: ${error.message || error}`, 'error');
            }
        }

        async function runMacroCommand(command) {
            const instanceId = getSelectedInstance();
            pushCommandMessage('user', `MACRO(${instanceId.toUpperCase()}::all): ${command}`);
            rememberCommandContext(['all'], command);
            const options = getControlOptions();
            try {
                const response = await fetch('/api/agent/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        instance_id: instanceId,
                        target: 'all',
                        command,
                        priority: 'high',
                        options
                    }),
                });
                const data = await response.json();
                if (data.success) {
                    showToast('success', `Macro thành công: ${command}`);
                    pushCommandMessage('system', summarizeCommandResponse(data), 'system');
                } else {
                    showToast('warning', data.error || `Macro lỗi: ${command}`);
                    pushCommandMessage('system', summarizeCommandResponse(data), 'error');
                }
                loadAgentsStatus();
                loadAgentActivity();
            } catch (error) {
                console.error('Failed macro command:', error);
                showToast('error', 'Lệnh macro thất bại');
                pushCommandMessage('system', `Macro lỗi: ${error.message || error}`, 'error');
            }
        }

        async function sendAgentCommand() {
            const target = document.getElementById('fleet-target')?.value || 'all';
            const input = document.getElementById('fleet-command');
            const command = (input?.value || '').trim();
            if (!command) return;

            if (input) input.value = '';
            const instanceId = getSelectedInstance();
            pushCommandMessage('user', `${instanceId.toUpperCase()}::${String(target).toUpperCase()}: ${command}`);
            rememberCommandContext([String(target).toLowerCase()], command);
            const options = getControlOptions();
            try {
                const response = await fetch('/api/agent/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        instance_id: instanceId,
                        target,
                        command,
                        priority: 'medium',
                        options
                    }),
                });
                const data = await response.json();
                if (data.success) {
                    showToast('success', `Đã gửi tới ${target}`);
                    pushCommandMessage('system', summarizeCommandResponse(data), 'system');
                } else {
                    showToast('error', data.error || 'Lệnh thất bại');
                    pushCommandMessage('system', summarizeCommandResponse(data), 'error');
                }
                loadAgentsStatus();
                loadAgentActivity();
            } catch (error) {
                console.error('Failed to send agent command:', error);
                showToast('error', 'Không gửi được lệnh');
                pushCommandMessage('system', `Gửi lệnh thất bại: ${error.message || error}`, 'error');
            }
        }

        async function sendBatchCommand() {
            const container = document.getElementById('fleet-target-checks');
            const input = document.getElementById('fleet-batch-command');
            const command = (input?.value || '').trim();
            if (!container || !command) return;

            const checked = Array.from(container.querySelectorAll('input[type="checkbox"]:checked'))
                .map((el) => el.value)
                .filter(Boolean);
            if (!checked.length) {
                showToast('warning', 'Hãy chọn ít nhất một agent');
                return;
            }

            if (input) input.value = '';
            const instanceId = getSelectedInstance();
            pushCommandMessage('user', `BATCH(${instanceId.toUpperCase()}: ${checked.join(', ')}): ${command}`);
            rememberCommandContext(checked.map((item) => String(item).toLowerCase()), command);
            const options = getControlOptions();
            try {
                const response = await fetch('/api/agents/command/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        instance_id: instanceId,
                        targets: checked,
                        command,
                        priority: 'medium',
                        options
                    }),
                });
                const data = await response.json();
                const summary = data.summary || {};
                if (data.success) {
                    showToast('success', `Batch thành công: ${summary.success || checked.length}/${summary.total || checked.length}`);
                    pushCommandMessage('system', summarizeCommandResponse(data), 'system');
                } else {
                    showToast('warning', `Batch một phần: ${summary.success || 0}/${summary.total || checked.length}`);
                    pushCommandMessage('system', summarizeCommandResponse(data), 'error');
                }
                loadAgentsStatus();
                loadAgentActivity();
                loadOpsFeed();
            } catch (error) {
                console.error('Failed batch dispatch:', error);
                showToast('error', 'Batch thất bại');
                pushCommandMessage('system', `Batch lỗi: ${error.message || error}`, 'error');
            }
        }

        async function sendInstanceCommand(target, command, optionsOverride) {
            const instanceId = getSelectedInstance();
            if (!target || !command) return;
            const options = { ...(getControlOptions() || {}) };
            if (optionsOverride && typeof optionsOverride === 'object') {
                Object.assign(options, optionsOverride);
            }
            pushCommandMessage('user', `${instanceId.toUpperCase()}::${String(target).toUpperCase()}: ${command}`);
            rememberCommandContext([String(target).toLowerCase()], command);
            try {
                const response = await fetch('/api/orion/instances/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        instance_id: instanceId,
                        target,
                        command,
                        priority: 'high',
                        options,
                    }),
                });
                const data = await response.json();
                if (data.success) {
                    showToast('success', `${target.toUpperCase()} • ${command}`);
                    pushCommandMessage('system', summarizeCommandResponse(data), 'system');
                } else {
                    showToast('warning', data.error || 'Lệnh thất bại');
                    pushCommandMessage('system', summarizeCommandResponse(data), 'error');
                }
                loadOrionInstances();
                loadAgentActivity();
            } catch (error) {
                console.error('Failed instance command:', error);
                showToast('error', 'Không gửi được lệnh instance');
                pushCommandMessage('system', `Gửi lệnh thất bại: ${error.message || error}`, 'error');
            }
        }

        async function loadOpsFeed() {
            const agent = document.getElementById('ops-filter-agent')?.value || 'all';
            const level = document.getElementById('ops-filter-level')?.value || 'all';
            try {
                const response = await fetch(`/api/events/feed?limit=120&agent=${encodeURIComponent(agent)}&level=${encodeURIComponent(level)}&include_routing=true`);
                const data = await response.json();
                state.opsFeed = data.events || [];
                scheduleOpsFeedRender();
                scheduleInsightRender();
            } catch (error) {
                console.error('Failed to load ops feed:', error);
            }
        }

        async function loadOpsDigest() {
            try {
                const response = await fetch('/api/events/digest?limit=160');
                const data = await response.json();
                state.opsDigest = data?.digest || null;
                scheduleInsightRender();
            } catch (error) {
                console.error('Failed to load ops digest:', error);
            }
        }

        function addOpsEvent(event) {
            if (!event) return;
            state.opsFeed = [event, ...(state.opsFeed || [])];
            if (state.opsFeed.length > 180) state.opsFeed = state.opsFeed.slice(0, 180);
            scheduleOpsFeedRender();
            scheduleInsightRender();
        }

        function renderOpsFeed(events) {
            const list = document.getElementById('ops-feed-list');
            const count = document.getElementById('ops-feed-count');
            if (!list) return;

            const rowsRaw = Array.isArray(events) ? events : [];
            const rows = state.logView === 'raw' ? rowsRaw : filterValuableEvents(rowsRaw);
            if (count) count.textContent = `${rows.length} sự kiện`;
            if (!rows.length) {
                list.innerHTML = '<div class="empty-state-text">Không có sự kiện quan trọng</div>';
                return;
            }

            list.innerHTML = rows.slice(0, 120).map((event) => {
                const agent = escapeHtml((event.agent || 'system').toUpperCase());
                const type = escapeHtml((event.type || 'event').replaceAll('_', ' '));
                const time = formatTime(event.timestamp);
                const level = escapeHtml(event.level || 'info');
                const message = escapeHtml(event.message || '');
                return `
                    <div class="ops-item">
                        <div class="ops-item-head">
                            <span>${agent} · ${time} · ${level}</span>
                            <span class="ops-item-type">${type}</span>
                        </div>
                        <div class="ops-item-message">${message}</div>
                    </div>
                `;
            }).join('');
        }

        function initRoutingAdvisor() {
            const taskSelect = document.getElementById('advisor-task-type');
            if (!taskSelect) return;
            hydrateTaskTypeOptions([
                'code_generation',
                'code_review',
                'refactoring',
                'ui_analysis',
                'screenshot_analysis',
                'security_audit',
                'vulnerability_scan',
                'test_generation',
                'test_execution',
                'deployment',
                'monitoring',
                'planning',
                'decision_making',
                'permission_review',
            ]);
            runRoutingAdvisor();
        }

        function hydrateTaskTypeOptions(taskTypes) {
            const taskSelect = document.getElementById('advisor-task-type');
            if (!taskSelect || !Array.isArray(taskTypes) || taskTypes.length === 0) return;

            const previous = taskSelect.value || 'code_generation';
            taskSelect.innerHTML = taskTypes.map((task) => {
                const label = task.replaceAll('_', ' ').replace(/\b\w/g, (char) => char.toUpperCase());
                return `<option value="${escapeHtml(task)}">${escapeHtml(label)}</option>`;
            }).join('');

            if (taskTypes.includes(previous)) {
                taskSelect.value = previous;
            }
        }

        async function loadModelRoutingStatus() {
            try {
                const response = await fetch('/api/model-routing/status');
                const data = await response.json();
                state.modelRouting = data;
                updateModelRoutingUI(data);
            } catch (error) {
                console.error('Failed to load model routing status:', error);
            }
        }

        async function loadRoutingEvents() {
            try {
                const response = await fetch('/api/model-routing/events?limit=8');
                const data = await response.json();
                renderRoutingEvents(data.events || []);
            } catch (error) {
                console.error('Failed to load routing events:', error);
            }
        }

        function updateModelRoutingUI(routing) {
            const budget = routing?.budget || {};
            const budgetRatio = Math.max(0, Math.min(2, Number(budget.budget_ratio || 0)));
            const budgetPct = Math.min(100, Math.round(budgetRatio * 100));
            const totalCost = Number(budget.total_cost_usd || 0);
            const dailyBudget = Number(budget.daily_budget_usd || 0);
            const liveModel = routing?.live_model || routing?.last_event?.selected_model || null;
            const avgLatency = Number(routing?.recent?.avg_latency_ms || 0);

            const circle = document.getElementById('budget-progress-circle');
            const circumference = 163.36;
            if (circle) {
                const offset = circumference * (1 - Math.min(1, budgetRatio));
                circle.style.strokeDashoffset = String(offset);
            }

            const progressValue = document.getElementById('budget-progress-value');
            if (progressValue) progressValue.textContent = `${budgetPct}%`;

            const summary = document.getElementById('budget-summary');
            if (summary) {
                summary.textContent = `Budget $${totalCost.toFixed(3)} / $${dailyBudget.toFixed(2)}`;
            }

            const liveModelEl = document.getElementById('routing-live-model');
            if (liveModelEl) liveModelEl.textContent = liveModel || 'No route yet';

            const indicator = document.getElementById('routing-live-indicator');
            if (indicator) {
                const isOffline = !liveModel;
                indicator.classList.toggle('offline', isOffline);
                indicator.textContent = isOffline ? 'IDLE' : 'ROUTING';
            }

            const tokenEl = document.getElementById('routing-total-tokens');
            if (tokenEl) tokenEl.textContent = formatCompactNumber(Number(routing?.total_tokens || 0));

            const callsEl = document.getElementById('routing-total-calls');
            if (callsEl) callsEl.textContent = formatCompactNumber(Number(routing?.total_calls || 0));

            const latencyEl = document.getElementById('routing-latency');
            if (latencyEl) latencyEl.textContent = `${avgLatency}ms`;

            if (Array.isArray(routing?.task_types)) {
                hydrateTaskTypeOptions(routing.task_types);
            }
        }

        function renderRoutingEvents(events) {
            const container = document.getElementById('routing-events');
            if (!container) return;
            if (!events.length) {
                container.innerHTML = '<div class="empty-state-text">No routing events yet</div>';
                return;
            }

            container.innerHTML = events.map((event) => {
                const success = !!event.success;
                const model = escapeHtml(event.selected_model || 'unknown');
                const task = escapeHtml(event.task_type || 'unknown');
                const agent = escapeHtml(event.agent || 'agent');
                const tokens = Number((event.usage || {}).total_tokens || event.estimated_tokens || 0);
                const latency = event.duration_ms != null ? `${Number(event.duration_ms)}ms` : '-';
                const time = formatTime(event.timestamp);
                return `
                    <div class="routing-event">
                        <span class="routing-dot ${success ? '' : 'fail'}"></span>
                        <div class="routing-event-main">
                            <div class="line-1">${agent} · ${model} · ${task}</div>
                            <div class="line-2">${time} · ${formatCompactNumber(tokens)} tok</div>
                        </div>
                        <div class="routing-event-latency">${latency}</div>
                    </div>
                `;
            }).join('');
        }

        async function runRoutingAdvisor() {
            const resultEl = document.getElementById('advisor-result');
            if (!resultEl) return;

            const payload = {
                task_type: document.getElementById('advisor-task-type')?.value || 'code_generation',
                complexity: document.getElementById('advisor-complexity')?.value || '',
                importance: document.getElementById('advisor-importance')?.value || 'normal',
                estimated_tokens: Number(document.getElementById('advisor-estimated-tokens')?.value || 1200),
                prefer_speed: !!document.getElementById('advisor-prefer-speed')?.checked,
                prefer_cost: !!document.getElementById('advisor-prefer-cost')?.checked,
            };

            try {
                resultEl.innerHTML = 'Computing routing recommendation...';
                const response = await fetch('/api/model-routing/recommend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await response.json();

                const chain = (data.routing?.runtime_chain || []).slice(0, 5).join(' -> ') || 'No runtime chain available';
                const topCosts = (data.estimated_costs || []).slice(0, 3)
                    .map((x) => `${x.model}: $${Number(x.cost_usd || 0).toFixed(4)}`)
                    .join(' | ');
                const notes = (data.notes || []).map((n) => `- ${escapeHtml(n)}`).join('<br>');

                resultEl.innerHTML = `
                    <strong>Recommended:</strong> ${escapeHtml(data.recommended_model || 'n/a')}<br>
                    <strong>Cheapest runtime:</strong> ${escapeHtml(data.cheapest_runtime_model || 'n/a')}<br>
                    <strong>Runtime chain:</strong> ${escapeHtml(chain)}<br>
                    <strong>Cost snapshot:</strong> ${escapeHtml(topCosts || 'n/a')}<br>
                    <strong>Notes:</strong><br>${notes || '- No notes'}
                `;
            } catch (error) {
                console.error('Failed to run routing advisor:', error);
                resultEl.textContent = 'Failed to get routing recommendation';
                showToast('error', 'Không lấy được đề xuất router');
            }
        }

        function pushCommandMessage(role, text, tone = 'system') {
            const entry = {
                id: '',
                role: role || 'system',
                tone: tone || 'system',
                text: String(text || ''),
                timestamp: new Date().toISOString(),
            };
            state.commandHistory.push(entry);
            if (state.commandHistory.length > 120) {
                state.commandHistory = state.commandHistory.slice(-120);
            }
            scheduleCommandRender();
        }

        function upsertCommandMessage(id, role, text, tone = 'system') {
            const key = String(id || '').trim();
            if (!key) {
                pushCommandMessage(role, text, tone);
                return;
            }
            const now = new Date().toISOString();
            const idx = state.commandHistory.findIndex((item) => String(item.id || '') === key);
            if (idx === -1) {
                state.commandHistory.push({
                    id: key,
                    role: role || 'assistant',
                    tone: tone || 'system',
                    text: String(text || ''),
                    timestamp: now,
                });
            } else {
                state.commandHistory[idx] = {
                    ...state.commandHistory[idx],
                    role: role || state.commandHistory[idx].role,
                    tone: tone || state.commandHistory[idx].tone,
                    text: String(text || state.commandHistory[idx].text || ''),
                    timestamp: now,
                };
            }
            if (state.commandHistory.length > 120) {
                state.commandHistory = state.commandHistory.slice(-120);
            }
            scheduleCommandRender();
        }

        function applyChatReport(report) {
            if (!report || typeof report !== 'object') return;
            const normalized = {
                status: String(report.status || 'Đang cập nhật'),
                summary: String(report.summary || ''),
                highlights: Array.isArray(report.highlights) ? report.highlights : [],
                next_action: String(report.next_action || report.nextAction || ''),
            };
            state.chatReport = normalized;
            const statusEl = document.getElementById('report-status');
            const summaryEl = document.getElementById('report-summary');
            const highlightsEl = document.getElementById('report-highlights');
            const nextEl = document.getElementById('report-next');
            if (statusEl) statusEl.textContent = normalized.status || 'Đang cập nhật';
            if (summaryEl) summaryEl.textContent = normalized.summary || 'Không có tóm tắt.';
            if (highlightsEl) {
                highlightsEl.textContent = normalized.highlights.length
                    ? normalized.highlights.join(' | ')
                    : 'Không có điểm chính mới.';
            }
            if (nextEl) nextEl.textContent = normalized.next_action || 'Tiếp tục theo dõi.';
        }

        function renderCommandConsole() {
            const container = document.getElementById('command-console');
            if (!container) return;

            if (!state.commandHistory.length) {
                container.innerHTML = `
                        <div class="command-msg system">
                        <div class="command-msg-head">Hệ thống</div>
                        Phản hồi lệnh sẽ hiển thị realtime tại đây.
                    </div>
                `;
                return;
            }

            container.innerHTML = state.commandHistory.slice(-40).map((item) => {
                const className = item.tone === 'error' ? 'error' : (item.role === 'user' ? 'user' : 'system');
                const head = item.role === 'user' ? 'Bạn' : (item.role === 'assistant' ? 'Trợ lý' : 'Hệ thống');
                return `
                    <div class="command-msg ${className}">
                        <div class="command-msg-head">${head} · ${formatTime(item.timestamp)}</div>
                        ${escapeHtml(item.text)}
                    </div>
                `;
            }).join('');
            container.scrollTop = container.scrollHeight;
        }

        function toggleCommandLive() {
            state.commandLive = !state.commandLive;
            syncCommandLiveToggle();
            if (state.commandLive) {
                pushCommandMessage('system', 'Đã bật luồng realtime', 'system');
            }
        }

        function syncCommandLiveToggle() {
            const btn = document.getElementById('command-live-toggle');
            if (!btn) return;
            btn.classList.toggle('active', !!state.commandLive);
            btn.textContent = state.commandLive ? 'Realtime ON' : 'Realtime OFF';
        }

        function rememberCommandContext(targets, command) {
            const normalizedTargets = Array.from(new Set((targets || [])
                .map((item) => String(item || '').trim().toLowerCase())
                .filter(Boolean)));
            state.commandContext = {
                active: true,
                issuedAt: Date.now(),
                command: String(command || ''),
                targets: normalizedTargets.length ? normalizedTargets : ['all'],
            };
        }

        function streamAgentLogToCommandConsole(agent, entry) {
            if (!state.commandLive) return;
            if (!entry || !agent) return;

            const now = Date.now();
            const ctx = state.commandContext || {};
            const inWindow = ctx.active && (now - Number(ctx.issuedAt || 0)) < 120000;
            const target = String(agent).toLowerCase();
            const watchingTarget = inWindow && (
                (ctx.targets || []).includes('all') ||
                (ctx.targets || []).includes(target) ||
                ((ctx.targets || []).includes('orion') && target === 'orion')
            );

            const message = String(entry.message || '');
            const level = String(entry.level || 'info').toLowerCase();
            const isControlSignal = /(dashboard command|command handled|command failed|batch|interrupt|paused orchestrator|resumed orchestrator|exception)/i.test(message);
            const severe = level === 'error' || level === 'warning' || level === 'success';

            if (!isControlSignal && !(watchingTarget && severe)) return;
            pushCommandMessage('system', `${target.toUpperCase()}: ${truncateText(message, 220)}`, toneFromLevel(level));
        }

        function maybeNarrateAgentActivity(activity) {
            if (!state.commandLive) return;
            if (!activity || typeof activity !== 'object') return;
            const highlights = Array.isArray(activity.highlights)
                ? activity.highlights.filter(Boolean).slice(0, 2)
                : [];
            const summary = String(activity.summary || '').trim();
            if (!summary && !highlights.length) return;

            const signature = `${activity.instance_id || 'orion'}:${activity.iteration ?? 'n/a'}:${highlights.join('|')}`;
            const now = Date.now();
            const last = state.liveNarration || { lastKey: '', lastAt: 0 };
            if (signature === last.lastKey && (now - Number(last.lastAt || 0)) < 18000) return;
            if ((now - Number(last.lastAt || 0)) < 12000) return;

            const text = highlights.length
                ? `${summary || 'Realtime'} • ${highlights.join(' | ')}`
                : summary;
            pushCommandMessage('system', `Realtime: ${truncateText(text, 260)}`, 'system');
            state.liveNarration = { lastKey: signature, lastAt: now };
        }

        function toneFromLevel(level) {
            const value = String(level || 'info').toLowerCase();
            if (value === 'error' || value === 'warning') return 'error';
            return 'system';
        }

        function getControlOptions() {
            const mode = document.getElementById('fleet-control-mode')?.value || 'interrupt';
            const resumeAfter = !!document.getElementById('fleet-resume-after')?.checked;
            return {
                control_mode: mode,
                resume_after: resumeAfter,
            };
        }

        function summarizeCommandResponse(response) {
            const instance = String(response?.instance_id || response?.result?.instance_id || '').toUpperCase();
            const target = String(response?.target || 'system').toUpperCase();
            const scope = instance ? `${instance}::${target}` : target;
            if (!response) return `${target}: không có phản hồi`;
            if (!response.success) return `${scope}: ${response.error || response.result?.error || 'thất bại'}`;

            const result = response.result || {};
            if (response.summary) {
                const summary = response.summary;
                return `${scope}: batch thành công ${summary.success || 0}/${summary.total || 0}`;
            }
            if (result.status) {
                const s = result.status;
                return `${scope} trạng thái -> chạy=${!!s.running}, tạm_dừng=${!!s.paused}, vòng=${s.iteration ?? 'n/a'}`;
            }
            if (result.agent_control || response.control) {
                const c = result.agent_control || response.control || {};
                const enabled = c.enabled !== false;
                const reason = c.reason ? ` (${c.reason})` : '';
                return `${scope}: autopilot ${enabled ? 'ON' : 'OFF'}${reason}`;
            }
            if (result.note) {
                return `${scope}: ${result.note}`;
            }
            if (result.control) {
                const c = result.control;
                if (c.auto_paused) {
                    return `${scope}: đã ngắt để điều khiển${c.resume_after ? ', đã tiếp tục' : ''}`;
                }
            }
            if (result.result && typeof result.result === 'object') {
                if (result.result.iteration != null && result.result.score != null) {
                    return `${scope}: vòng #${result.result.iteration} điểm=${Number(result.result.score).toFixed(1)}`;
                }
                if (result.result.agent) {
                    return `${scope}: ${result.result.agent} hoàn thành (ok=${result.result.success !== false})`;
                }
            }
            if (response.note) return `${scope}: ${response.note}`;
            return `${scope}: đã xử lý lệnh`;
        }

        function humanizeLogMessage(message) {
            const text = String(message || '').trim();
            const lower = text.toLowerCase();
            if (!text) return '';
            if (lower.includes('phase 1') && lower.includes('dispatch')) return 'Orion đang điều phối các agent chạy song song.';
            if (lower.includes('phase 2') && lower.includes('security')) return 'Cipher đang rà soát bảo mật.';
            if (lower.includes('phase 3') && lower.includes('decision')) return 'Orion đang tổng hợp kết quả để ra quyết định.';
            if (lower.includes('phase 4') && lower.includes('needs improvement')) return 'Chu kỳ chưa đạt, cần cải thiện thêm trước khi deploy.';
            if (lower.includes('cycle score')) return 'Đã cập nhật điểm chất lượng chu kỳ.';
            if (lower.includes('routing attempt')) return 'Đang thử tuyến model phù hợp.';
            if (lower.includes('subscription fallback')) return 'Đang chuyển sang model dự phòng.';
            if (lower.includes('subscription cli failed')) return 'Model dự phòng gặp lỗi cấu hình khi gọi CLI.';
            if (lower.includes("code': '1113'") || lower.includes('余额不足')) return 'API báo hết ngân sách hoặc không có gói khả dụng.';
            if (lower.includes("code': '1211'") || lower.includes('模型不存在')) return 'API báo model không tồn tại hoặc alias sai.';
            if (lower.includes('resource_exhausted') || lower.includes('quota')) return 'Vượt quota API, cần giảm tải hoặc đổi model.';
            if (lower.includes('dashboard command')) return 'Dashboard vừa gửi lệnh điều phối.';
            if (lower.includes('command handled')) return 'Agent đã xử lý xong lệnh.';
            if (lower.includes('command failed')) return 'Lệnh thất bại, cần xem chi tiết nguyên nhân.';
            if (lower.includes('agent control')) return 'Đã cập nhật autopilot cho agent theo yêu cầu dashboard.';
            if (lower.includes('autopilot') && lower.includes('off')) return 'Một agent vừa được tắt autopilot.';
            if (lower.includes('autopilot') && lower.includes('on')) return 'Một agent vừa được bật lại autopilot.';
            return truncateText(text, 180);
        }

        function logTimestampValue(log, fallbackIndex = 0) {
            const raw = log?.timestamp ?? log?.time ?? log?.ts ?? log?.at ?? log?.created_at ?? log?.createdAt;
            if (typeof raw === 'number' && Number.isFinite(raw)) return raw;
            if (raw) {
                const parsed = Date.parse(String(raw));
                if (!Number.isNaN(parsed)) return parsed;
            }
            return fallbackIndex;
        }

        function sortLogsNewestFirst(logs) {
            const rows = Array.isArray(logs) ? logs : [];
            return rows
                .map((log, idx) => ({
                    log,
                    ts: logTimestampValue(log, idx),
                    idx,
                }))
                .sort((a, b) => (b.ts - a.ts) || (b.idx - a.idx))
                .map((item) => item.log);
        }

        function compressLogsForDisplay(logs, limit = 12) {
            const rows = Array.isArray(logs) ? logs.slice(-180) : [];
            const grouped = new Map();
            rows.forEach((log, idx) => {
                const level = String(log?.level || 'info').toLowerCase();
                const human = humanizeLogMessage(log?.message || '');
                const key = `${level}:${normalizeDigestMessage(human)}`;
                const timestamp = log?.timestamp || new Date().toISOString();
                const tsValue = logTimestampValue(log, idx);
                if (!grouped.has(key)) {
                    grouped.set(key, {
                        level,
                        message: human,
                        timestamp,
                        tsValue,
                        count: 1,
                    });
                } else {
                    const item = grouped.get(key);
                    item.count += 1;
                    if (tsValue >= item.tsValue) {
                        item.tsValue = tsValue;
                        item.timestamp = timestamp;
                    }
                }
            });
            const compact = Array.from(grouped.values())
                .sort((a, b) => (b.tsValue - a.tsValue))
                .slice(0, Math.max(4, limit))
                .map((item) => ({
                    ...item,
                    message: item.count > 1 ? `${item.message} (x${item.count})` : item.message,
                }));
            return compact.map(({ tsValue, ...rest }) => rest);
        }

        function filterValuableLogs(logs) {
            const rows = Array.isArray(logs) ? logs : [];
            return rows.filter((log) => {
                const level = String(log?.level || 'info').toLowerCase();
                const message = String(log?.message || '').toLowerCase();
                if (level === 'error' || level === 'warning' || level === 'success') return true;
                return /(dashboard command|command handled|interrupt|paused|resumed|approved|declined|deployed|failed|exception|veto|status|watchdog|recovery|autopilot|stuck)/i.test(message);
            });
        }

        function filterValuableEvents(events) {
            const rows = Array.isArray(events) ? events : [];
            return rows.filter((event) => {
                const level = String(event?.level || 'info').toLowerCase();
                const message = String(event?.message || '');
                if (level === 'error' || level === 'warning' || level === 'success') return true;
                return /(decision|routing|command|interrupt|paused|resumed|failed|exception)/i.test(message);
            });
        }

        function normalizeDigestMessage(message) {
            return String(message || '')
                .replace(/\d{2}:\d{2}:\d{2}/g, '')
                .replace(/\biteration\s*#?\d+\b/ig, 'iteration')
                .replace(/\b\d+(\.\d+)?(ms|s|m|h)\b/ig, '')
                .replace(/\s+/g, ' ')
                .trim()
                .slice(0, 140);
        }

        function buildInsightDigest() {
            const allLogs = Object.values(state.agentLogs || {}).flat();
            const recentLogs = allLogs.slice(-180);
            const valuable = filterValuableLogs(recentLogs);
            const usable = valuable.slice(-90);
            const digest = state.opsDigest || {};
            const totalEvents = Number(digest.total_events || recentLogs.length || 0);
            const valuableEvents = Number(digest.valuable_events || valuable.length || 0);
            const noisePct = totalEvents > 0 ? Math.max(0, Math.min(100, Number(digest.noise_reduction_pct || Math.round(((totalEvents - valuableEvents) / totalEvents) * 100)))) : 0;
            const keyEvents = Array.isArray(digest.key_events) ? digest.key_events : [];

            if (!usable.length) {
                return {
                    headline: 'Hệ thống đang yên ổn',
                    summary: 'Không có cảnh báo hoặc lỗi nổi bật trong thời gian gần đây.',
                    action: 'Tiếp tục quan sát ở chế độ tối giản.',
                    noise: `Đã lọc ~${noisePct}% log nhiễu (${valuableEvents}/${totalEvents} tín hiệu giữ lại).`,
                    key_events: keyEvents.length ? keyEvents.map((x) => x?.message).filter(Boolean).slice(0, 2).join(' | ') : 'Chưa có tín hiệu mới.',
                };
            }

            const severity = { error: 0, warning: 0, success: 0, info: 0 };
            const agentCount = {};
            const errorPatterns = {};
            let latestImportant = usable[usable.length - 1];

            for (const log of usable) {
                const level = String(log.level || 'info').toLowerCase();
                const agent = String(log.agent || 'system').toLowerCase();
                const message = String(log.message || '');
                if (severity[level] != null) severity[level] += 1;
                agentCount[agent] = (agentCount[agent] || 0) + 1;
                if (level === 'error' || level === 'warning') {
                    const key = normalizeDigestMessage(message);
                    if (key) errorPatterns[key] = (errorPatterns[key] || 0) + 1;
                }
            }

            const hottestAgent = Object.entries(agentCount).sort((a, b) => b[1] - a[1])[0]?.[0] || 'system';
            const topIssue = Object.entries(errorPatterns).sort((a, b) => b[1] - a[1])[0]?.[0] || '';
            const messageLower = String(topIssue || latestImportant?.message || '').toLowerCase();

            let headline = `Tâm điểm: ${String(hottestAgent).toUpperCase()} đang tạo nhiều tín hiệu`;
            let summary = `${severity.error} lỗi, ${severity.warning} cảnh báo, ${severity.success} tín hiệu tốt.`;
            let action = 'Ưu tiên kiểm tra agent có nhiều lỗi nhất trước.';

            if (/quota|balance|余额不足|resource_exhausted|429/.test(messageLower)) {
                headline = 'Tắc nghẽn tài nguyên mô hình';
                summary = 'Phát hiện lỗi quota/chi phí API lặp lại, ảnh hưởng chu trình tự động.';
                action = 'Giảm vòng gọi model nặng hoặc chuyển model fallback chi phí thấp.';
            } else if (/model not found|不存在|1211/.test(messageLower)) {
                headline = 'Sai định danh model';
                summary = 'Có lệnh gọi model không tồn tại hoặc mapping model chưa đúng.';
                action = 'Kiểm tra cấu hình router và alias model trước khi chạy tiếp.';
            } else if (severity.error === 0 && severity.warning === 0) {
                headline = 'Luồng vận hành ổn định';
                summary = `Gần đây chủ yếu là tín hiệu tích cực (${severity.success} bản ghi).`;
                action = 'Giữ chế độ tối giản, chỉ mở log chi tiết khi debug.';
            } else if (/command|interrupt|paused|resumed/.test(messageLower)) {
                headline = 'Có thao tác điều khiển thủ công';
                summary = 'Hệ thống vừa nhận lệnh điều phối trực tiếp từ dashboard.';
                action = 'Theo dõi kết quả command trong 1-2 phút để xác nhận tác động.';
            }

            return {
                headline,
                summary,
                action,
                noise: `Đã lọc ~${noisePct}% log nhiễu (${valuableEvents}/${totalEvents} tín hiệu giữ lại).`,
                key_events: keyEvents.length ? keyEvents.map((x) => x?.message).filter(Boolean).slice(0, 2).join(' | ') : 'Chưa có sự kiện giá trị mới.',
            };
        }

        function renderInsightDigest() {
            state.insight = buildInsightDigest();
            const headline = document.getElementById('insight-headline');
            const summary = document.getElementById('insight-summary');
            const action = document.getElementById('insight-action');
            const noise = document.getElementById('insight-noise');
            const keyEvents = document.getElementById('insight-key-events');
            if (headline) headline.textContent = state.insight.headline;
            if (summary) summary.textContent = state.insight.summary;
            if (action) action.textContent = state.insight.action;
            if (noise) noise.textContent = state.insight.noise || 'Đang tính toán...';
            if (keyEvents) keyEvents.textContent = state.insight.key_events || 'Chưa có.';
        }

        function scheduleOrionLogsRender() {
            if (orionLogsRenderScheduled) return;
            orionLogsRenderScheduled = true;
            requestAnimationFrame(() => {
                orionLogsRenderScheduled = false;
                updateOrionLogs();
            });
        }

        function scheduleGuardianLogsRender() {
            if (guardianLogsRenderScheduled) return;
            guardianLogsRenderScheduled = true;
            requestAnimationFrame(() => {
                guardianLogsRenderScheduled = false;
                updateGuardianLogs();
            });
        }

        function scheduleOpsFeedRender() {
            if (opsFeedRenderScheduled) return;
            opsFeedRenderScheduled = true;
            setTimeout(() => {
                opsFeedRenderScheduled = false;
                renderOpsFeed(state.opsFeed || []);
            }, 120);
        }

        function scheduleCommandRender() {
            if (commandRenderScheduled) return;
            commandRenderScheduled = true;
            requestAnimationFrame(() => {
                commandRenderScheduled = false;
                renderCommandConsole();
            });
        }

        function scheduleInsightRender() {
            if (insightRenderScheduled) return;
            insightRenderScheduled = true;
            setTimeout(() => {
                insightRenderScheduled = false;
                renderInsightDigest();
            }, 160);
        }

        function scheduleFleetRender() {
            if (fleetRenderScheduled) return;
            fleetRenderScheduled = true;
            setTimeout(() => {
                fleetRenderScheduled = false;
                updateFleetUI();
            }, 120);
        }

        function scheduleFlowRender() {
            if (flowRenderScheduled) return;
            flowRenderScheduled = true;
            setTimeout(() => {
                flowRenderScheduled = false;
                renderFlowOverview();
            }, 100);
        }

        // Utilities
        function truncateText(value, maxLength = 220) {
            const text = String(value || '');
            if (text.length <= maxLength) return text;
            return `${text.slice(0, maxLength - 1)}…`;
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            return new Date(timestamp).toLocaleTimeString();
        }

        function formatRelativeTime(timestamp) {
            if (!timestamp) return 'Chưa có';
            const then = new Date(timestamp).getTime();
            if (!Number.isFinite(then)) return 'Không rõ';
            const deltaSec = Math.max(0, Math.floor((Date.now() - then) / 1000));
            if (deltaSec < 5) return 'Vừa xong';
            if (deltaSec < 60) return `${deltaSec} giây trước`;
            if (deltaSec < 3600) return `${Math.floor(deltaSec / 60)} phút trước`;
            return `${Math.floor(deltaSec / 3600)} giờ trước`;
        }

        function formatCompactNumber(value) {
            const number = Number(value || 0);
            if (number >= 1000000) return `${(number / 1000000).toFixed(1)}m`;
            if (number >= 1000) return `${(number / 1000).toFixed(1)}k`;
            return `${Math.round(number)}`;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateScoreSparkline(score) {
            const numericScore = Number(score || 0);
            state.scoreHistory.push(numericScore);
            if (state.scoreHistory.length > 24) state.scoreHistory.shift();

            const path = document.getElementById('score-sparkline-path');
            if (!path || state.scoreHistory.length < 2) return;

            const width = 120;
            const height = 30;
            const min = Math.min(...state.scoreHistory);
            const max = Math.max(...state.scoreHistory);
            const range = Math.max(0.1, max - min);
            const stepX = width / Math.max(1, state.scoreHistory.length - 1);

            const segments = state.scoreHistory.map((value, index) => {
                const x = Math.round(index * stepX * 100) / 100;
                const y = Math.round((height - ((value - min) / range) * (height - 4) - 2) * 100) / 100;
                return `${index === 0 ? 'M' : 'L'}${x},${y}`;
            });

            path.setAttribute('d', segments.join(' '));
        }

        function showToast(type, message) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const icons = { success: '✓', warning: '!', error: 'x', info: 'i' };
            const toast = document.createElement('div');
            toast.className = `toast ${type || 'info'}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <span class="toast-message">${escapeHtml(message || '')}</span>
                <button class="toast-close" aria-label="Đóng">x</button>
            `;

            const close = () => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 180);
            };
            toast.querySelector('.toast-close')?.addEventListener('click', close);
            container.appendChild(toast);
            setTimeout(close, 3800);
        }

        function startUptimeCounter() {
            setInterval(() => {
                const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('uptime').textContent =
                    minutes > 0 ? `${minutes}m` : `${seconds}s`;
            }, 1000);
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function refreshDashboard() {
            loadInitialState();
            loadAgentsStatus();
            loadOrionInstances();
            loadAgentActivity();
            loadMonitorAutopilot();
            loadComputerControlStatus();
            loadProviderCatalog();
            loadProviderProfile(false);
            loadModelRoutingStatus();
            loadRoutingEvents();
            loadOpsFeed();
            loadOpsDigest();
            loadSystemSlo();
        }

        function renderRateLimitChip() {
            const chip = document.getElementById('rate-limit-chip');
            if (!chip) return;
            const rl = state?.systemSlo?.api_rate_limit || {};
            const blocked = Number(rl.blocked_last_window || 0);
            const windowSec = Number(rl.window_sec || 300);
            const windowMin = Math.max(1, Math.round(windowSec / 60));
            const high = blocked >= 8;
            chip.textContent = `Rate Limit: ${high ? 'WARN' : 'NORMAL'} (${blocked}/${windowMin}m)`;
            if (high) {
                chip.classList.remove('chip-success');
                chip.classList.add('chip-warning');
            } else {
                chip.classList.remove('chip-warning');
                chip.classList.add('chip-success');
            }
        }

        async function loadSystemSlo() {
            try {
                const response = await fetch('/api/system/slo');
                const data = await response.json();
                if (data?.slo) {
                    state.systemSlo = data.slo;
                    renderRateLimitChip();
                }
            } catch (error) {
                console.error('Failed to load system SLO:', error);
            }
        }

        const openclawStatus = {
            url: 'http://127.0.0.1:18789/',
            status: 'unknown',
            error: null,
            controlOn: false,
            dashboard: null,
            metrics: null,
        };
        let openclawLastToastAt = 0;
        let openclawLastToastKey = '';
        let openclawOpenInFlight = false;
        let openclawLastWindowOpenAt = 0;
        let openclawLastWindowUrl = '';

        const showOpenClawToastOnce = (type, message, key, cooldownMs = 30000) => {
            const now = Date.now();
            const normalizedKey = String(key || '').trim() || String(message || '').trim();
            if (!normalizedKey) return;
            if (openclawLastToastKey === normalizedKey && now - openclawLastToastAt < cooldownMs) {
                return;
            }
            openclawLastToastKey = normalizedKey;
            openclawLastToastAt = now;
            showToast(type, message);
        };

        const renderOpenClawStatus = (dashboardPayload, metricsPayload) => {
            const statusElement = document.getElementById('computer-control-chip');
            if (!statusElement) return;
            const healthOk = !!(dashboardPayload?.health_ok ?? metricsPayload?.token?.health_ok);
            const attachRate = Number(metricsPayload?.attach_success_rate || 0);
            const flowRate = Number(metricsPayload?.flow_success_rate || 0);
            const cliFailures = Number(metricsPayload?.counters?.cli_failures || 0);
            const queueDepth = Number(metricsPayload?.queue?.total_queue_depth || 0);
            const queueP95 = Number(metricsPayload?.queue?.queue_wait_p95_ms || 0);
            const label = healthOk ? "READY" : "DEGRADED";
            statusElement.textContent = `OpenClaw: ${label} · Ctrl:${openclawStatus.controlOn ? 'ON' : 'OFF'} · Attach:${Math.round(attachRate * 100)}% · Flow:${Math.round(flowRate * 100)}% · CLI:${cliFailures} · Q:${queueDepth} · Qp95:${queueP95}ms`;
            if (healthOk) {
                statusElement.classList.remove('chip-warning');
                statusElement.classList.add('chip-success');
            } else {
                statusElement.classList.remove('chip-success');
                statusElement.classList.add('chip-warning');
            }
        };

        const refreshOpenClawStatus = () => {
            Promise.all([
                fetch('/api/openclaw/dashboard').then(async (response) => ({ ok: response.ok, data: await response.json().catch(() => ({})) })),
                fetch('/api/openclaw/metrics').then((response) => response.json()),
            ])
                .then(([dashboardResp, metricsData]) => {
                    const dashboardData = dashboardResp?.data || {};
                    openclawStatus.url = dashboardData?.url || openclawStatus.url;
                    openclawStatus.status = dashboardData?.success ? 'ready' : 'missing';
                    openclawStatus.error = dashboardData?.error;
                    openclawStatus.dashboard = dashboardData || null;
                    openclawStatus.metrics = metricsData?.metrics || null;
                    renderOpenClawStatus(openclawStatus.dashboard, openclawStatus.metrics);
                    if (!dashboardResp?.ok || !dashboardData?.success) {
                        const msg = dashboardData?.error || 'OpenClaw gateway chưa sẵn sàng.';
                        showOpenClawToastOnce('warning', msg, `status:${msg}`, 45000);
                    }
                })
                .catch((error) => {
                    console.error('Failed to fetch OpenClaw status:', error);
                    showOpenClawToastOnce('error', 'Không thể kiểm tra OpenClaw.', 'status-network', 45000);
                });
        };

        function openOpenClaw() {
            if (openclawOpenInFlight) return;
            openclawOpenInFlight = true;
            fetch('/api/openclaw/dashboard?refresh=1')
                .then(async (response) => ({ ok: response.ok, data: await response.json().catch(() => ({})) }))
                .then(({ ok, data }) => {
                    const url = data?.url || 'http://127.0.0.1:18789/';
                    openclawStatus.url = url;
                    openclawStatus.status = data?.success ? 'ready' : 'missing';
                    openclawStatus.error = data?.error || null;
                    openclawStatus.dashboard = data || null;
                    renderOpenClawStatus(openclawStatus.dashboard, openclawStatus.metrics);
                    if (!ok || !data?.success) {
                        showOpenClawToastOnce('error', data?.error || 'OpenClaw chưa sẵn sàng. Không mở tab mới.', `open:${data?.error || 'not_ready'}`, 8000);
                        return;
                    }
                    const now = Date.now();
                    if (openclawLastWindowUrl === url && (now - openclawLastWindowOpenAt) < 4000) {
                        showOpenClawToastOnce('info', 'OpenClaw vừa được mở, bỏ qua thao tác lặp.', `open-debounce:${url}`, 2500);
                        return;
                    }
                    openclawLastWindowUrl = url;
                    openclawLastWindowOpenAt = now;
                    window.open(url, '_blank', 'noopener');
                })
                .catch((error) => {
                    console.error('Failed to open OpenClaw:', error);
                    showOpenClawToastOnce('error', 'Không mở được OpenClaw. Hãy kiểm tra gateway.', 'open-network', 8000);
                })
                .finally(() => {
                    openclawOpenInFlight = false;
                });
        }

        function emergencyShutdown() {
            if (confirm('⚠️ Dừng khẩn cấp?\n\nHành động này sẽ dừng toàn bộ agent ngay lập tức.')) {
                quickCommand('SHUTDOWN');
            }
        }
    </script>
    <!-- Floating Chat Widget -->
    <div id="floating-chat" class="floating-chat">
        <div class="chat-toggle" onclick="toggleFloatingChat()">
            <span class="chat-icon">💬</span>
            <span class="chat-badge" id="chat-badge" style="display:none">0</span>
        </div>
        <div class="chat-window" id="chat-window">
            <div class="chat-header">
                <span>🤖 Nexus AI</span>
                <span class="chat-status" id="socket-status">●</span>
                <button class="chat-close" onclick="toggleFloatingChat()">×</button>
            </div>
            <div class="chat-messages" id="chat-messages">
                <div class="chat-msg bot">
                    <div class="chat-msg-text">Xin chào! Tôi là Nexus AI. Bạn có thể chat trực tiếp với tôi ở đây - nhận phản hồi tức thì.</div>
                    <div class="chat-msg-time">Bây giờ</div>
                </div>
            </div>
            <div class="chat-typing" id="chat-typing" style="display:none">
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Nhập tin nhắn..."
                       onkeypress="if(event.key==='Enter')sendFloatingChat()">
                <button onclick="sendFloatingChat()">➤</button>
            </div>
        </div>
    </div>

    <style>
        .floating-chat { position: fixed; bottom: 20px; right: 20px; z-index: 10000; font-family: inherit; }
        .chat-toggle {
            width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4); transition: transform 0.2s;
            position: relative;
        }
        .chat-toggle:hover { transform: scale(1.1); }
        .chat-icon { font-size: 28px; }
        .chat-badge {
            position: absolute; top: -5px; right: -5px; background: #ef4444; color: white;
            font-size: 12px; padding: 2px 6px; border-radius: 10px;
        }
        .chat-window {
            position: absolute; bottom: 70px; right: 0; width: 360px; height: 480px;
            background: #1a1a2e; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            display: none; flex-direction: column; overflow: hidden; border: 1px solid #333;
        }
        .chat-window.open { display: flex; }
        .chat-header {
            padding: 12px 16px; background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; display: flex; align-items: center; gap: 8px; font-weight: 600;
        }
        .chat-status { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; margin-left: auto; }
        .chat-status.disconnected { background: #ef4444; }
        .chat-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 10px; }
        .chat-msg { max: 85%; padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.4; }
        .chat-msg.user { align-self: flex-end; background: #667eea; color: white; }
        .chat-msg.bot { align-self: flex-start; background: #2d2d44; color: #e2e8f0; }
        .chat-msg-time { font-size: 10px; opacity: 0.6; margin-top: 4px; }
        .chat-typing { padding: 8px 16px; display: flex; gap: 4px; align-items: center; }
        .typing-dot { width: 8px; height: 8px; background: #667eea; border-radius: 50%; animation: typing 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
        .chat-input-area { padding: 12px; border-top: 1px solid #333; display: flex; gap: 8px; }
        .chat-input-area input {
            flex: 1; padding: 10px 14px; border-radius: 20px; border: 1px solid #444;
            background: #2d2d44; color: white; font-size: 14px;
        }
        .chat-input-area input:focus { outline: none; border-color: #667eea; }
        .chat-input-area button {
            width: 40px; height: 40px; border-radius: 50%; border: none;
            background: #667eea; color: white; cursor: pointer; font-size: 18px;
        }
    </style>

    <script>
        let chatOpen = false;
        const floatingChatStreams = {};
        let floatingChatUnread = 0;

        function setFloatingChatBadge(count) {
            const badge = document.getElementById('chat-badge');
            if (!badge) return;
            const value = Math.max(0, Number(count || 0));
            if (value <= 0) {
                badge.style.display = 'none';
                badge.textContent = '0';
                return;
            }
            badge.style.display = 'inline-block';
            badge.textContent = value > 99 ? '99+' : String(value);
        }

        function normalizeChatNodeId(raw) {
            const text = String(raw || '');
            return text.replace(/[^a-zA-Z0-9:_-]/g, '_') || `chat_${Date.now()}`;
        }

        function toggleFloatingChat() {
            chatOpen = !chatOpen;
            document.getElementById('chat-window').classList.toggle('open', chatOpen);
            if (chatOpen) {
                floatingChatUnread = 0;
                setFloatingChatBadge(0);
                const input = document.getElementById('chat-input');
                if (input) input.focus();
            }
        }

        async function sendFloatingChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;
            addChatMessage('user', msg, { markUnread: false });
            input.value = '';
            showTyping(true);
            const pendingNodeId = normalizeChatNodeId(`stream:${Date.now()}`);
            addChatMessage('bot', 'Đang xử lý yêu cầu realtime...', { id: pendingNodeId, markUnread: false });
            try {
                const instanceId = (typeof getSelectedInstance === 'function') ? getSelectedInstance() : 'orion-1';
                const resp = await fetch('/api/chat/ask', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: msg, instance_id: instanceId })
                });
                const data = await resp.json();
                if (!data?.success) {
                    showTyping(false);
                    addChatMessage('bot', data?.error || 'Không xử lý được yêu cầu.', { id: pendingNodeId, markUnread: true });
                    return;
                }
                if (data?.message_id) {
                    floatingChatStreams[String(data.message_id)] = pendingNodeId;
                }
                if (data?.reply) {
                    addChatMessage('bot', data.reply, { id: pendingNodeId, markUnread: true });
                }
                if (!data?.message_id) {
                    showTyping(false);
                }
            } catch(e) {
                showTyping(false);
                addChatMessage('bot', 'Lỗi: ' + e.message, { id: pendingNodeId, markUnread: true });
            }
        }

        function addChatMessage(role, text, options = {}) {
            const container = document.getElementById('chat-messages');
            if (!container) return;
            const nodeId = normalizeChatNodeId(options.id || `${role}:${Date.now()}`);
            const existing = container.querySelector(`.chat-msg[data-chat-id="${nodeId}"]`);
            const escaped = safeEscapeHtml(text);

            if (existing) {
                const textEl = existing.querySelector('.chat-msg-text');
                if (textEl) textEl.innerHTML = escaped;
                const timeEl = existing.querySelector('.chat-msg-time');
                if (timeEl) timeEl.textContent = new Date().toLocaleTimeString();
            } else {
                const div = document.createElement('div');
                div.className = 'chat-msg ' + role;
                div.dataset.chatId = nodeId;
                div.innerHTML = `<div class="chat-msg-text">${escaped}</div><div class="chat-msg-time">${new Date().toLocaleTimeString()}</div>`;
                container.appendChild(div);
            }

            if (!chatOpen && role === 'bot' && options.markUnread !== false) {
                floatingChatUnread += 1;
                setFloatingChatBadge(floatingChatUnread);
            }
            container.scrollTop = container.scrollHeight;
        }

        function floatingPhaseLabel(phase) {
            const map = {
                thinking: 'Đang phân tích',
                routing: 'Đang chọn route',
                processing: 'Đang xử lý',
                report: 'Đang cập nhật report',
                final: 'Hoàn tất',
            };
            return map[String(phase || '').toLowerCase()] || 'Đang xử lý';
        }

        function handleFloatingChatStream(payload) {
            const messageId = String(payload?.message_id || '').trim();
            if (!messageId) return;
            const nodeId = floatingChatStreams[messageId];
            if (!nodeId) return;
            const phase = String(payload?.phase || '').toLowerCase();
            const text = String(payload?.text || '').trim();
            if (!text) return;
            if (phase === 'final') {
                addChatMessage('bot', text, { id: nodeId, markUnread: true });
                showTyping(false);
                delete floatingChatStreams[messageId];
                return;
            }
            addChatMessage('bot', `[${floatingPhaseLabel(phase)}] ${text}`, { id: nodeId, markUnread: false });
        }

        function showTyping(show) {
            document.getElementById('chat-typing').style.display = show ? 'flex' : 'none';
        }

        function safeEscapeHtml(value) {
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        // Socket status
        socket.on('connect', () => { document.getElementById('socket-status').classList.remove('disconnected'); });
        socket.on('disconnect', () => { document.getElementById('socket-status').classList.add('disconnected'); });
        socket.on('chat_stream', handleFloatingChatStream);

        // ========== UI/UX IMPROVEMENTS ==========

        // 1. Command Palette (Ctrl+K)
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                toggleCommandPalette();
            }
            if (e.key === 'Escape') {
                document.getElementById('command-palette')?.classList.remove('open');
            }
        });
        function toggleCommandPalette() {
            let p = document.getElementById('command-palette');
            if (!p) {
                p = document.createElement('div');
                p.id = 'command-palette';
                p.className = 'command-palette';
                p.innerHTML = `<div class="palette-backdrop" onclick="toggleCommandPalette()"></div>
                    <div class="palette-modal">
                        <div class="palette-icon">⌘</div>
                        <input type="text" class="palette-input" placeholder="Gõ lệnh hoặc tìm kiếm..." autofocus>
                        <div class="palette-results">
                            <div class="palette-item" onclick="quickCommand('status')"><span>📊</span> Trạng thái hệ thống</div>
                            <div class="palette-item" onclick="quickCommand('pause')"><span>⏸</span> Pause Orion</div>
                            <div class="palette-item" onclick="quickCommand('resume')"><span>▶</span> Resume Orion</div>
                            <div class="palette-item" onclick="toggleFloatingChat()"><span>💬</span> Mở chat</div>
                            <div class="palette-item" onclick="toggleTheme()"><span>🎨</span> Đổi theme</div>
                        </div>
                        <div class="palette-hint">Ctrl+K để mở • Esc để đóng</div>
                    </div>`;
                document.body.appendChild(p);
            }
            setTimeout(() => p.classList.toggle('open'), 10);
        }

        // 2. Floating Action Button
        const fab = document.createElement('div');
        fab.className = 'fab-container';
        fab.innerHTML = `<button class="fab-main" onclick="toggleFabMenu()">+</button>
            <div class="fab-menu" id="fab-menu">
                <button onclick="quickCommand('status')" title="Status">📊</button>
                <button onclick="quickCommand('pause')" title="Pause">⏸</button>
                <button onclick="quickCommand('resume')" title="Resume">▶</button>
                <button onclick="toggleFloatingChat()" title="Chat">💬</button>
                <button onclick="toggleCommandPalette()" title="Commands">⌘</button>
            </div>`;
        document.body.appendChild(fab);
        function toggleFabMenu() { document.getElementById('fab-menu').classList.toggle('open'); }

        // 3. Theme Toggle
        function toggleTheme() {
            const themes = ['dark', 'light', 'midnight'];
            const current = document.body.getAttribute('data-theme') || 'dark';
            const next = themes[(themes.indexOf(current) + 1) % themes.length];
            document.body.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
        }
        const saved = localStorage.getItem('theme');
        if (saved) document.body.setAttribute('data-theme', saved);

        // 4. Keyboard Shortcuts Display (?)
        document.addEventListener('keydown', (e) => {
            if (e.key === '?' && e.target.tagName !== 'INPUT') {
                showShortcutsModal();
            }
        });
        function showShortcutsModal() {
            let m = document.getElementById('shortcuts-modal');
            if (!m) {
                m = document.createElement('div');
                m.id = 'shortcuts-modal';
                m.className = 'shortcuts-modal';
                m.innerHTML = `<div class="modal-backdrop" onclick="showShortcutsModal()"></div>
                    <div class="modal-content">
                        <h3>⌨️ Keyboard Shortcuts</h3>
                        <div class="shortcut-list">
                            <div class="shortcut"><kbd>Ctrl+K</kbd><span>Mở command palette</span></div>
                            <div class="shortcut"><kbd>?</kbd><span>Hiện shortcuts này</span></div>
                            <div class="shortcut"><kbd>Ctrl+P</kbd><span>Pause Orion</span></div>
                            <div class="shortcut"><kbd>Ctrl+R</kbd><span>Resume Orion</span></div>
                            <div class="shortcut"><kbd>Enter</kbd><span>Gửi lệnh chat</span></div>
                            <div class="shortcut"><kbd>Esc</kbd><span>Đóng modal</span></div>
                        </div>
                    </div>`;
                document.body.appendChild(m);
            }
            setTimeout(() => m.classList.add('open'), 10);
        }

        // 5. Real-time Connection Status Indicator
        const statusBar = document.createElement('div');
        statusBar.className = 'realtime-status-bar';
        statusBar.innerHTML = `<span class="status-dot"></span><span id="status-text">Connected</span>
            <span class="status-iteration" id="status-iteration">#0</span>`;
        document.body.appendChild(statusBar);
        socket.on('status_update', (data) => {
            const iter = data?.orion_instances?.[0]?.iteration || 0;
            document.getElementById('status-iteration').textContent = '#' + iter;
        });
        socket.on('disconnect', () => { document.querySelector('.status-dot').classList.add('offline'); });
        socket.on('connect', () => { document.querySelector('.status-dot').classList.remove('offline'); });

        // 6. Animated Welcome
        setTimeout(() => {
            showToast('info', '🎯 Nhấn Ctrl+K để mở Command Palette');
        }, 2000);

        // ========== STYLES ==========
        const improvementsCSS = `
            /* Command Palette */
            .command-palette { position: fixed; inset: 0; z-index: 20000; display: none; align-items: flex-start; justify-content: center; padding-top: 10vh; }
            .command-palette.open { display: flex; }
            .palette-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
            .palette-modal { position: relative; width: 500px; background: #1a1a2e; border-radius: 16px; border: 1px solid #444; box-shadow: 0 20px 60px rgba(0,0,0,0.5); overflow: hidden; animation: slideDown 0.2s ease; }
            @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
            .palette-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); font-size: 20px; opacity: 0.5; }
            .palette-input { width: 100%; padding: 20px 20px 20px 50px; border: none; background: transparent; color: white; font-size: 18px; outline: none; border-bottom: 1px solid #333; }
            .palette-results { max-height: 300px; overflow-y: auto; padding: 8px; }
            .palette-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; cursor: pointer; color: #ccc; transition: all 0.15s; }
            .palette-item:hover { background: #667eea; color: white; }
            .palette-item span:first-child { font-size: 18px; }
            .palette-hint { padding: 12px 16px; font-size: 12px; color: #666; border-top: 1px solid #333; }

            /* FAB */
            .fab-container { position: fixed; bottom: 90px; right: 20px; z-index: 9999; }
            .fab-main { width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, #f59e0b, #d97706); border: none; color: white; font-size: 28px; cursor: pointer; box-shadow: 0 4px 20px rgba(245, 158, 11, 0.4); transition: transform 0.2s; }
            .fab-main:hover { transform: rotate(90deg); }
            .fab-menu { display: none; flex-direction: column; gap: 8px; position: absolute; bottom: 70px; right: 0; }
            .fab-menu.open { display: flex; }
            .fab-menu button { width: 48px; height: 48px; border-radius: 50%; border: none; background: #1a1a2e; color: white; font-size: 20px; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.3); transition: transform 0.15s; }
            .fab-menu button:hover { transform: scale(1.15); background: #667eea; }

            /* Shortcuts Modal */
            .shortcuts-modal { position: fixed; inset: 0; z-index: 20000; display: none; align-items: center; justify-content: center; }
            .shortcuts-modal.open { display: flex; }
            .modal-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.7); }
            .modal-content { position: relative; background: #1a1a2e; border-radius: 16px; padding: 24px; width: 400px; border: 1px solid #444; }
            .modal-content h3 { margin: 0 0 16px; color: white; }
            .shortcut { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #333; }
            .shortcut kbd { background: #333; padding: 4px 10px; border-radius: 4px; color: #667eea; font-family: monospace; }
            .shortcut span { color: #888; }

            /* Status Bar */
            .realtime-status-bar { position: fixed; top: 0; left: 0; right: 0; height: 32px; background: rgba(26, 26, 46, 0.95); border-bottom: 1px solid #333; display: flex; align-items: center; padding: 0 16px; gap: 12px; font-size: 12px; z-index: 10001; backdrop-filter: blur(10px); }
            .status-dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; animation: pulse 2s infinite; }
            .status-dot.offline { background: #ef4444; animation: none; }
            @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
            .status-iteration { margin-left: auto; color: #667eea; font-weight: 600; }

            /* Theme variations */
            body[data-theme="light"] { --bg-primary: #f8fafc; --bg-secondary: #fff; --text-primary: #1e293b; }
            body[data-theme="midnight"] { --bg-primary: #0f0f23; --bg-secondary: #1a1a2e; --text-primary: #e2e8f0; --accent: #a78bfa; }
        `;
        const style = document.createElement('style');
        style.textContent = improvementsCSS;
        document.head.appendChild(style);
    </script>
</body>
</html>
